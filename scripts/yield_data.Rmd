Yield data analysis
========================================================

## Set working directory  
```{r set working directory}
getwd()
#setwd("D:/work/repos/trost_phenotypes")
#setwd("~/work/repos/trost_phenotypes/")
```


[solution for issue with working directory and knitr](https://github.com/yihui/knitr/issues/277)

## Load workspace, packages and scripts
```{r load workspace, message=FALSE}
# load packages
library(knitr)
library(ggplot2)
library(reshape)
library(pander)
library(multcomp)
library(extrafont)

# set options for pander
panderOptions('table.split.table', 200)

# set options for knitr
opts_chunk$set(fig.width=5, fig.height=5, cache=FALSE, highlight = TRUE, fig.show="asis")
opts_knit$set(root.dir = '../')

# load workspace
#load("yield_data.RData")
```


## Source R functions
```{r source R functions, include=FALSE}
source("../libpurzel/names.R")
source("../libpurzel/colors.R")
source("../libpurzel/func_appendList.R")
source("../libpurzel/func_anova_v2.R")
source("../libpurzel/func_ttest.R")
source("../libpurzel/func_aggregate_values.R")
source("../libpurzel/func_modify_yield_data.R")
source("../libpurzel/func_get_yield_data.R")
source("../libpurzel/func_starch_yield_mpitest.R")
source("../libpurzel/func_starch_yield_mpipruef.R")
source("../libpurzel/func_starch_yield_feld.R")
source("../libpurzel/func_starch_yield_jkitest.R")
source("../libpurzel/func_starch_yield_jki_feld_2012.R")
source("../libpurzel/func_starch_yield_feld_check.R")
source("../libpurzel/func_starch_yield_mpipruef_check.R")
source("../libpurzel/func_starch_yield_jki_feld_2012_check.R")
source("../libpurzel/func_yield_plots.R")
source("../libpurzel/func_calc_stress_index.R")
source("../libpurzel/func_calc_relSY.R")
source("../libpurzel/func_calc_drym.R")
```


### Get yield data (from phenotyper)
```{r, get yield data}
#yield_data <- func_get_yield_data()
#write.table(yield_data, "data/yield_data.txt", sep="\t")

yield_data_raw <- read.table("data/yield_data.txt", sep="\t", header=TRUE)

yield_data_raw <- func_modify_yield_data(yield_data_raw)
pander(table(yield_data_raw$culture, yield_data_raw$attribute))
table(yield_data_raw$treatment)
#levels(yield_data_raw$cultivar)
```


### remove outlier
**1107281: Milva, stress, MPI Feld 2011 --> tuber yield too high!**
**1074641: Saturna, stress, MPI Test 1.2 --> drymatter too high! (30%)**
**1282690: Maxilla, control, MPI Pruef3 --> drymatter too high! (56%)**
**1282642: Kormoran, control, MPI Pruef3 --> drymatter too high! (45%)**
**1332240: Logo, control, MPI Pruef4 --> drymatter too high! (43%)**
**1332201: Ulme, control, MPI Pruef4 --> drymatter too high! (43%)**
```{r remove outlier}
remove_outlier <- which(yield_data_raw$plant_id %in% c(1170281, 1074641, 1282690, 1282642, 1332201, 1332240))
tuber_rows <- which(yield_data_raw$entity_id %in% c(12,810))

# select only rows containing data about tuber data AND outlier
pander( yield_data_raw[intersect(remove_outlier, tuber_rows), ])

yield_data <- yield_data_raw

# replace outlier numbers by NA
yield_data[intersect(remove_outlier, tuber_rows), "number"] <- NA
# result:
pander( yield_data[intersect(remove_outlier, tuber_rows), ])
```


### Calculate starch yield per experiment --> contains drymatter (%), starch content (g/kg) and starch yield (kg/plant and g/plant)
```{r calculate starch yield}

# greenhouse trials: only check cultivars
mpi_test_1_2 <- func_starch_yield_mpitest(yield_data, 48656)
mpi_test_2 <- func_starch_yield_mpitest(yield_data, 51790)
jki_test_1 <- func_starch_yield_jkitest(yield_data, 45985)
jki_test_2 <- func_starch_yield_jkitest(yield_data, 57802)

# greenhouse trials with all cultivars
pruef1 <- func_starch_yield_mpipruef(yield_data, 56575)
pruef2 <- func_starch_yield_mpipruef(yield_data, 58243)
pruef3 <- func_starch_yield_mpipruef(yield_data, 60319)
pruef4 <- func_starch_yield_mpipruef(yield_data, 62030)

jki_shelter_1 <- func_starch_yield_feld(yield_data, 45990, 1)
jki_shelter_2 <- func_starch_yield_feld(yield_data, 57803, 2)

# field trials: ALL Cultivars!
mpi_field_2011 <- func_starch_yield_feld(yield_data, 44443, 8)
mpi_field_2012 <- func_starch_yield_feld(yield_data, 56726, 8)
mpi_field_2013 <- func_starch_yield_feld(yield_data, 62326, 8)
jki_field_2013 <- func_starch_yield_feld(yield_data, 62327, 6)
dethlingen_2011 <- func_starch_yield_feld(yield_data, 46150, 31)
dethlingen_2012 <- func_starch_yield_feld(yield_data, 56877, 31)
dethlingen_2013 <- func_starch_yield_feld(yield_data, 62328, 31)

jki_field_2012 <- func_starch_yield_jki_feld_2012(yield_data, 56875, 6)

# ONLY 4 check cultivars!

mpi_field_2011_check <- func_starch_yield_feld_check(yield_data, 44443, 8)
mpi_field_2012_check <- func_starch_yield_feld_check(yield_data, 56726, 8)
mpi_field_2013_check <- func_starch_yield_feld_check(yield_data, 62326, 8)
jki_field_2013_check <- func_starch_yield_feld_check(yield_data, 62327, 6)
# dethlingen_2011_check <- func_starch_yield_feld_check(yield_data, 46150, 31) # keine Check-Kultivare im Versuch!
dethlingen_2012_check <- func_starch_yield_feld_check(yield_data, 56877, 31)
dethlingen_2013_check <- func_starch_yield_feld_check(yield_data, 62328, 31)
jki_shelter_1_check <- func_starch_yield_feld_check(yield_data, 45990, 1)
jki_shelter_2_check <- func_starch_yield_feld_check(yield_data, 57803, 1)

pruef1_check <- func_starch_yield_mpipruef_check(yield_data, 56575)
pruef2_check <- func_starch_yield_mpipruef_check(yield_data, 58243)
pruef3_check <- func_starch_yield_mpipruef_check(yield_data, 60319)
pruef4_check <- func_starch_yield_mpipruef_check(yield_data, 62030)

jki_field_2012_check <- func_starch_yield_jki_feld_2012_check(yield_data, 56875, 6)
```


```{r ANOVA for starch yield}
# test trials
mpi_test_1_2_anova <- func_anova_2fac_ia(mpi_test_1_2, "starch_yield_g_per_plant", "cultivar", "treatment", 0.01)
mpi_test_2_anova <- func_anova_2fac_ia(mpi_test_2, "starch_yield_g_per_plant", "cultivar", "treatment", 0.01)
jki_test_1_anova <- func_anova_2fac_ia(jki_test_1, "starch_yield_g_per_plant", "cultivar", "treatment", 0.01)
jki_test_2_anova <- func_anova_2fac_ia(jki_test_2, "starch_yield_g_per_plant", "cultivar", "treatment", 0.01)

test_trials_anova <- func_combine_anova_res(mpi_test_1_2_anova, mpi_test_2_anova, jki_test_1_anova, 
                                            jki_test_2_anova, "f_value", "p_value", "treatment", "cultivar")
rownames(test_trials_anova) <- c("MPI-MP greenhouse trial 1", "MPI-MP greenhouse trial 2", 
                                 "JKI greenhouse trial 1", "JKI greenhouse trial 2")
write.table(test_trials_anova, "output/starch_yield_test_trials_anova.txt", 
            sep="\t", quote=F, row.names=T, col.names=NA)


################################################################################

# field trials, all cultivar
mpi_field_2011_anova <- func_anova_2fac_ia(mpi_field_2011, "starch_yield_g_per_plant", "cultivar", "treatment", 0.01)
mpi_field_2012_anova <- func_anova_2fac_ia(mpi_field_2012, "starch_yield_g_per_plant", "cultivar", "treatment", 0.01)
jki_field_2012_anova <- func_anova_2fac_ia(jki_field_2012, "starch_yield_g_per_plant", "cultivar", "treatment", 0.01)
jki_field_2013_anova <- func_anova_2fac_ia(jki_field_2013, "starch_yield_g_per_plant", "cultivar", "treatment", 0.01)

field_trials_anova <- func_combine_anova_res(mpi_field_2011_anova, mpi_field_2012_anova, jki_field_2012_anova, 
                                            jki_field_2013_anova, "f_value", "p_value", "treatment", "cultivar")
rownames(field_trials_anova) <- c("MPI-MP field trial 2011", "MPI-MP field trial 2012", 
                                  "JKI field trial 2012", "JKI field trial 2013")
write.table(field_trials_anova, "output/starch_yield_field_trials_anova.txt", 
            sep="\t", quote=F, row.names=T, col.names=NA)

################################################################################

# field trials, only check cultivars
mpi_field_2011_check_anova <- func_anova_2fac_ia(mpi_field_2011_check, "starch_yield_g_per_plant", "cultivar", "treatment", 0.01)
mpi_field_2012_check_anova <- func_anova_2fac_ia(mpi_field_2012_check, "starch_yield_g_per_plant", "cultivar", "treatment", 0.01)
jki_field_2012_check_anova <- func_anova_2fac_ia(jki_field_2012_check, "starch_yield_g_per_plant", "cultivar", "treatment", 0.01)
jki_field_2013_check_anova <- func_anova_2fac_ia(jki_field_2013_check, "starch_yield_g_per_plant", "cultivar", "treatment", 0.01)

field_trials_check_anova <- func_combine_anova_res(mpi_field_2011_check_anova, mpi_field_2012_check_anova, jki_field_2012_check_anova, 
                                            jki_field_2013_check_anova, "f_value", "p_value", "treatment", "cultivar")
rownames(field_trials_check_anova) <- c("MPI-MP field trial 2011", "MPI-MP field trial 2012", 
                                        "JKI field trial 2012", "JKI field trial 2013")
write.table(field_trials_check_anova, "output/starch_yield_field_trials_check_anova.txt", 
            sep="\t", quote=F, row.names=T, col.names=NA)
```


### plots for yield data
#### greenhouse trials
```{r plots for yield data: greenhouse trials}
pdf("figures/starch_yield_mpi_test_1_2_yield_plots.pdf", width=6, height=6)
par(mar=c(7, 4, 4, 2))
func_yield_plots(mpi_test_1_2, names_treatment_cultivar, "topright")
dev.off()

pdf("figures/starch_yield_mpi_test_2_yield_plots.pdf", width=6, height=6)
par(mar=c(7, 4, 4, 2))
func_yield_plots(mpi_test_2, names_treatment_cultivar, "topright")
dev.off()

pdf("figures/starch_yield_jki_test_1_yield_plots.pdf", width=6, height=6)
par(mar=c(7, 4, 4, 2))
func_yield_plots_jkitest(jki_test_1, names_treatment_cultivar, "topright")
dev.off()

pdf("figures/starch_yield_jki_test_2_yield_plots.pdf", width=6, height=6)
par(mar=c(7, 4, 4, 2))
func_yield_plots_jkitest(jki_test_2, names_treatment_cultivar, "topright")
dev.off()
```



#### field trials (all cultivars)
```{r plots for yield data: field trials (all cultivars)}
pdf("figures/starch_yield_mpi_field_2011_yield_plots.pdf", width=10, height=6)
par(mar=c(7, 4, 4, 2))
func_yield_plots_jkitest(mpi_field_2011, names_cultivar_all, "topright")
dev.off()

pdf("figures/starch_yield_mpi_field_2012_yield_plots.pdf", width=10, height=6)
par(mar=c(7, 4, 4, 2))
func_yield_plots_jkitest(mpi_field_2012, names_cultivar_all, "topright")
dev.off()

pdf("figures/starch_yield_mpi_field_2013_yield_plots.pdf", width=10, height=6)
par(mar=c(7, 4, 4, 2))
func_yield_plots_jkitest(mpi_field_2013, names_cultivar_33, "topright")
dev.off()

pdf("figures/starch_yield_jki_field_2012_yield_plots.pdf", width=10, height=6)
par(mar=c(7, 4, 4, 2))
func_yield_plots_jkitest(jki_field_2012, names_cultivar_all, "topright")
dev.off()

pdf("figures/starch_yield_jki_field_2013_yield_plots.pdf", width=10, height=6)
par(mar=c(7, 4, 4, 2))
func_yield_plots_jkitest(jki_field_2013, names_cultivar_all, "topright")
dev.off()

pdf("figures/starch_yield_dethlingen_2011_yield_plots.pdf", width=10, height=6)
par(mar=c(7, 4, 4, 2))
func_yield_plots_jkitest(dethlingen_2011, names_cultivar_30, "topleft")
dev.off()

pdf("figures/starch_yield_dethlingen_2012_yield_plots.pdf", width=10, height=6)
par(mar=c(7, 4, 4, 2))
func_yield_plots_jkitest(dethlingen_2012, names_cultivar_all, "topright")
dev.off()

pdf("figures/starch_yield_dethlingen_2013_yield_plots.pdf", width=10, height=6)
par(mar=c(7, 4, 4, 2))
func_yield_plots_jkitest(dethlingen_2013, names_cultivar_all, "topright")
dev.off()
```

#### field trials (only check cultivars)
```{r plots for yield data: greenhouse trials (only check cultivars)}
pdf("figures/starch_yield_mpi_field_2011_yield_plots_check_cultivars.pdf", width=6, height=6)
par(mar=c(7, 4, 4, 2))
func_yield_plots_jkitest(mpi_field_2011_check, names_treatment_cultivar, "topright")
dev.off()

pdf("figures/starch_yield_mpi_field_2012_yield_plots_check_cultivars.pdf", width=6, height=6)
par(mar=c(7, 4, 4, 2))
func_yield_plots_jkitest(mpi_field_2012_check, names_treatment_cultivar, "topright")
dev.off()

pdf("figures/starch_yield_mpi_field_2013_yield_plots_check_cultivars.pdf", width=6, height=6)
par(mar=c(7, 4, 4, 2))
func_yield_plots_jkitest(mpi_field_2013_check, names_treatment_cultivar, "topright")
dev.off()

pdf("figures/starch_yield_jki_field_2012_yield_plots_check_cultivars.pdf", width=6, height=6)
par(mar=c(7, 4, 4, 2))
func_yield_plots_jkitest(jki_field_2012_check, names_treatment_cultivar, "topright")
dev.off()

pdf("figures/starch_yield_jki_field_2013_yield_plots_check_cultivars.pdf", width=6, height=6)
par(mar=c(7, 4, 4, 2))
func_yield_plots_jkitest(jki_field_2013_check, names_treatment_cultivar, "topright")
dev.off()

pdf("figures/starch_yield_dethlingen_2012_yield_plots_check_cultivars.pdf", width=6, height=6)
par(mar=c(7, 4, 4, 2))
func_yield_plots_jkitest(dethlingen_2012_check, names_treatment_cultivar, "topright")
dev.off()

pdf("figures/starch_yield_dethlingen_2013_yield_plots_check_cultivars.pdf", width=6, height=6)
par(mar=c(7, 4, 4, 2))
func_yield_plots_jkitest(dethlingen_2013_check, names_treatment_cultivar, "topleft")
dev.off()
```


#### for phd-thesis
```{r for phd-thesis, fig.width=10}
# mpi test 1.2
#pdf("~/work/Doktorarbeit/figures/yield_mpitest1.pdf", width=6, height=6)
par(mar=c(7.5, 4.5, 0.5, 0.5))
func_starch_yield_plot(mpi_test_1_2, names_treatment_cultivar, "topright")
#dev.off()


# mpi field 2011 
# only check cultivars
#pdf("~/work/Doktorarbeit/figures/yield_mpifeld_2011_check.pdf", width=6, height=6)
par(mar=c(7.5, 4.5, 0.5, 0.5))
func_starch_yield_plot(mpi_field_2011_check, names_treatment_cultivar, "topright")
#dev.off()

# all cultivars
#pdf("~/work/Doktorarbeit/figures/yield_mpifeld_2011.pdf", width=10, height=6)
par(mar=c(5, 4.5, 0.5, 0.5))
func_starch_yield_plot(mpi_field_2011, names_cultivar_all_ids, "topright")
#dev.off()
```



### calculate stress index
#### stress index is 1 - (mean(SY_drought) / mean(SY_control))
```{r calculate stress index}
# mpi_field_2011_SI <- func_calc_stress_index(mpi_field_2011)

# ALL cultivars
dflist <- list(mpi_test_1_2, mpi_test_2, pruef1, pruef2, pruef3, pruef4, 
               jki_test_1, jki_test_2, jki_shelter_1, jki_shelter_2, 
               mpi_field_2011, mpi_field_2012, mpi_field_2013, 
               jki_field_2012, jki_field_2013, 
               dethlingen_2011, dethlingen_2012, dethlingen_2013)

all_SI_list <- lapply(dflist, func_calc_stress_index)
all_SI <- unlist(lapply(dflist, func_calc_stress_index))

# ONLY check cultivars (without Dethlingen 2011, because no check cuktivars included!)
dflist_check <- list(mpi_test_1_2, mpi_test_2, 
                     pruef1_check, pruef2_check, pruef3_check, pruef4_check, 
                     jki_test_1, jki_test_2, jki_shelter_1_check, jki_shelter_2_check, 
                     mpi_field_2011_check, mpi_field_2012_check, mpi_field_2013_check, 
                     jki_field_2012_check, jki_field_2013_check, 
                     dethlingen_2012_check, dethlingen_2013_check)

all_SI_check_list <- lapply(dflist_check, func_calc_stress_index)
all_SI_check <- unlist(lapply(dflist_check, func_calc_stress_index))

pdf("figures/starch_yield_stress_index.pdf", width=10, height=6)
par(mar=c(7, 4, 4, 2))
barplot(all_SI, ylim=c(0,1), ylab="stress index (SI)", names=names_trials, las=2, main="all cultivars", 
        col=c(rep("#FFA54D",2), rep("darkorange3",4), rep("#68C468",2), rep("forestgreen",2), 
              rep("lightblue",3) , rep("#3D3DF7",2), rep("darkblue",3)))

barplot(all_SI_check, ylim=c(0,1), ylab="stress index (SI)", names=names_trials[-16], las=2, main="only check cultivars", 
        col=c(rep("#FFA54D",2), rep("darkorange3",4), rep("#68C468",2), rep("forestgreen",2), 
              rep("lightblue",3) , rep("#3D3DF7",2), rep("darkblue",2)))
dev.off()
```


```{r calculate stress index phd-thesis, fig.width=10}
# ALL cultivars
dflist_phd <- list(mpi_test_1_2, mpi_test_2, pruef1, pruef2, pruef3, 
                   jki_test_1, jki_test_2, jki_shelter_1, jki_shelter_2, 
                   mpi_field_2011, mpi_field_2012, 
                   jki_field_2012, jki_field_2013, 
                   dethlingen_2011, dethlingen_2012)

all_SI_list_phd <- lapply(dflist_phd, func_calc_stress_index)
all_SI_phd <- unlist(lapply(dflist_phd, func_calc_stress_index))

# for phd-thesis:
#pdf("~/work/Doktorarbeit/figures/stress_index.pdf", width=12, height=6)
par(mar=c(6, 4.5, 0.5, 0), lheight=0.6) #lheight bestimmt Zeilenabstand in x-Achsenbeschriftung
end_point = 15*1.2 # because 15 trials
barplot(all_SI_phd, ylim=c(0,1), ylab="stress index (SI)", las=2, xaxt="n", space=0.2, cex.lab=1.4, cex.axis=1.2,
        col=c(rep("#FFA54D",2), rep("darkorange3",3), rep("#68C468",2), rep("forestgreen",2), 
              rep("lightblue",2) , rep("#3D3DF7",2), rep("darkblue",2)))
text(seq(1,end_point,by=1.2), -0.02, srt = 45, adj= 1, xpd = TRUE,labels = names_trials_phd, cex=1.2)
#dev.off()

#### mean SI values
all_SI_phd_summary <- cbind(names_trials_phd, all_SI_phd)
all_SI_phd_summary[order(all_SI_phd_summary[,2]),]

# field trials (without shelter)
mean(all_SI_phd[c(10,11,14,15)])
# 0.14
```



### Calculate Relative Starch Yield (RelSY)
#### test trials with check cultivars
```{r Calculate RelSY: test trials (check cultivars)}
mpi_test_1_2_relSY <- func_calc_relSY(mpi_test_1_2, cultivar_names = check_names)
mpi_test_2_relSY <- func_calc_relSY(mpi_test_2, cultivar_names = check_names)
jki_test_1_relSY <- func_calc_relSY(jki_test_1, cultivar_names = check_names)
jki_test_2_relSY <- func_calc_relSY(jki_test_2, cultivar_names = check_names)
jki_test_2_relSY <- func_calc_relSY(jki_test_2, cultivar_names = check_names)

# median per cultivar
mpi_test_1_2_relSY_median <- func_calc_relSY_median(mpi_test_1_2_relSY)
mpi_test_2_relSY_median <- func_calc_relSY_median(mpi_test_2_relSY)
jki_test_1_relSY_median <- func_calc_relSY_median(jki_test_1_relSY)
jki_test_2_relSY_median <- func_calc_relSY_median(jki_test_2_relSY)

# try out to apply func_calc_relSY on multiple datasets
# dflist_test <- list(mpi_test_1_2, mpi_test_2)
# test_result <- lapply(dflist_test, func_calc_relSY, cultivar_names = check_names)
# df_test <- data.frame(matrix(unlist(test_result), nrow=24, byrow=T))
```

#### greenhouse trials (all cultivars)
```{r Calculate RelSY: greenhouse trials (all cultivars)}
pruef1_relSY <- func_calc_relSY(pruef1)
pruef2_relSY <- func_calc_relSY(pruef2)
pruef3_relSY <- func_calc_relSY(pruef3)
pruef4_relSY <- func_calc_relSY(pruef4)
jki_shelter_1_relSY <- func_calc_relSY(jki_shelter_1)
jki_shelter_2_relSY <- func_calc_relSY(jki_shelter_2)

# median per cultivar
pruef1_relSY_median <- func_calc_relSY_median(pruef1_relSY)
pruef2_relSY_median <- func_calc_relSY_median(pruef2_relSY)
pruef3_relSY_median <- func_calc_relSY_median(pruef3_relSY)
pruef4_relSY_median <- func_calc_relSY_median(pruef4_relSY)
jki_shelter_1_relSY_median <- func_calc_relSY_median(jki_shelter_1_relSY)
jki_shelter_2_relSY_median <- func_calc_relSY_median(jki_shelter_2_relSY)
```

#### greenhouse trials (only check cultivars)
```{r Calculate RelSY: greenhouse trials (only check cultivars)}
pruef1_relSY_check <- func_calc_relSY(pruef1_check, cultivar_names = check_names)
pruef2_relSY_check <- func_calc_relSY(pruef2_check, cultivar_names = check_names)
pruef3_relSY_check <- func_calc_relSY(pruef3_check, cultivar_names = check_names)
pruef4_relSY_check <- func_calc_relSY(pruef4_check, cultivar_names = check_names)
jki_shelter_1_relSY_check <- func_calc_relSY(jki_shelter_1_check, cultivar_names = check_names)
jki_shelter_2_relSY_check <- func_calc_relSY(jki_shelter_2_check, cultivar_names = check_names)

# median per cultivar
pruef1_relSY_median_check <- func_calc_relSY_median(pruef1_relSY_check)
pruef2_relSY_median_check <- func_calc_relSY_median(pruef2_relSY_check)
pruef3_relSY_median_check <- func_calc_relSY_median(pruef3_relSY_check)
pruef4_relSY_median_check <- func_calc_relSY_median(pruef4_relSY_check)
jki_shelter_1_relSY_median_check <- func_calc_relSY_median(jki_shelter_1_relSY_check)
jki_shelter_2_relSY_median_check <- func_calc_relSY_median(jki_shelter_2_relSY_check)
```

#### field trials (all cultivars)
```{r Calculate RelSY: field trials (all cultivars)}
mpi_field_2011_relSY <- func_calc_relSY(mpi_field_2011)
mpi_field_2012_relSY <- func_calc_relSY(mpi_field_2012)
mpi_field_2013_relSY <- func_calc_relSY(mpi_field_2013)
jki_field_2012_relSY <- func_calc_relSY(jki_field_2012)
jki_field_2013_relSY <- func_calc_relSY(jki_field_2013)

# dethlingen_2011_relSY <- func_calc_relSY(dethlingen_2011, cultivar_names = dethlingen_2011_names) # different cultivar names because check cultivars are missing!
dethlingen_2011_relSY <- func_calc_relSY(dethlingen_2011)
dethlingen_2012_relSY <- func_calc_relSY(dethlingen_2012)
dethlingen_2013_relSY <- func_calc_relSY(dethlingen_2013)

# median per cultivar
mpi_field_2011_relSY_median <- func_calc_relSY_median(mpi_field_2011_relSY)
mpi_field_2012_relSY_median <- func_calc_relSY_median(mpi_field_2012_relSY)
mpi_field_2013_relSY_median <- func_calc_relSY_median(mpi_field_2013_relSY)
jki_field_2012_relSY_median <- func_calc_relSY_median(jki_field_2012_relSY)
jki_field_2013_relSY_median <- func_calc_relSY_median(jki_field_2013_relSY)
dethlingen_2011_relSY_median <- func_calc_relSY_median(dethlingen_2011_relSY)
dethlingen_2012_relSY_median <- func_calc_relSY_median(dethlingen_2012_relSY)
dethlingen_2013_relSY_median <- func_calc_relSY_median(dethlingen_2013_relSY)
```

#### field trials (only check cultivars)
```{r Calculate RelSY: field trials (only check cultivars)}
mpi_field_2011_relSY_check <- func_calc_relSY(mpi_field_2011_check, cultivar_names = check_names)
mpi_field_2012_relSY_check <- func_calc_relSY(mpi_field_2012_check, cultivar_names = check_names)
mpi_field_2013_relSY_check <- func_calc_relSY(mpi_field_2013_check, cultivar_names = check_names)
jki_field_2012_relSY_check <- func_calc_relSY(jki_field_2012_check, cultivar_names = check_names)
jki_field_2013_relSY_check <- func_calc_relSY(jki_field_2013_check, cultivar_names = check_names)
dethlingen_2011_relSY_check <- func_calc_relSY(dethlingen_2011, cultivar_names = check_names) # keine Check-Sorten enthalten!
dethlingen_2012_relSY_check <- func_calc_relSY(dethlingen_2012, cultivar_names = check_names)
dethlingen_2013_relSY_check <- func_calc_relSY(dethlingen_2013, cultivar_names = check_names)

# median per cultivar
mpi_field_2011_relSY_median_check <- func_calc_relSY_median(mpi_field_2011_relSY_check)
mpi_field_2012_relSY_median_check <- func_calc_relSY_median(mpi_field_2012_relSY_check)
mpi_field_2013_relSY_median_check <- func_calc_relSY_median(mpi_field_2013_relSY_check)
jki_field_2012_relSY_median_check <- func_calc_relSY_median(jki_field_2012_relSY_check)
jki_field_2013_relSY_median_check <- func_calc_relSY_median(jki_field_2013_relSY_check)
dethlingen_2011_relSY_median_check <- func_calc_relSY_median(dethlingen_2011_relSY_check) # keine Check-Sorten enthalten!
dethlingen_2012_relSY_median_check <- func_calc_relSY_median(dethlingen_2012_relSY_check) 
dethlingen_2013_relSY_median_check <- func_calc_relSY_median(dethlingen_2013_relSY_check)
```


### calculate DRYM
#### test trials (check cultivars)
```{r calculate drym: test trials (check cultivars)}
drym_mpi_test_1_2_old <- func_calc_drym_old(mpi_test_1_2_relSY, mpi_test_1_2_relSY_median, cultivar_names=check_names) # old function
drym_mpi_test_1_2 <- func_calc_drym(mpi_test_1_2_relSY, mpi_test_1_2_relSY_median, cultivar_names=check_names) # new function

median(drym_mpi_test_1_2$Alegria, na.rm=T)
drym_mpi_test_1_2_old$Alegria

drym_mpi_test_2 <- func_calc_drym(mpi_test_2_relSY, mpi_test_2_relSY_median, cultivar_names=check_names)
drym_jki_test_1 <- func_calc_drym(jki_test_1_relSY, jki_test_1_relSY_median, cultivar_names=check_names)
drym_jki_test_2 <- func_calc_drym(jki_test_2_relSY, jki_test_2_relSY_median, cultivar_names=check_names)

# median of DRYM per cultivar
median_drym_mpi_test_1_2 <- lapply(drym_mpi_test_1_2, median, na.rm=T)
median_drym_mpi_test_2 <- lapply(drym_mpi_test_2, median, na.rm=T)
median_drym_jki_test_1 <- lapply(drym_jki_test_1, median, na.rm=T)
median_drym_jki_test_2 <- lapply(drym_jki_test_2, median, na.rm=T)
```

#### greenhouse trials (all cultivars)
```{r calculate drym: greenhouse trials (all cultivars)}
drym_pruef1 <- func_calc_drym(pruef1_relSY, pruef1_relSY_median)
drym_pruef2 <- func_calc_drym(pruef2_relSY, pruef2_relSY_median)
drym_pruef3 <- func_calc_drym(pruef3_relSY, pruef3_relSY_median)
drym_pruef4 <- func_calc_drym(pruef4_relSY, pruef4_relSY_median)
drym_jki_shelter_1 <- func_calc_drym(jki_shelter_1_relSY, jki_shelter_1_relSY_median)
drym_jki_shelter_2 <- func_calc_drym(jki_shelter_2_relSY, jki_shelter_2_relSY_median)

# median of DRYM per cultivar
median_drym_pruef1 <- lapply(drym_pruef1, median, na.rm=T)
median_drym_pruef2 <- lapply(drym_pruef2, median, na.rm=T)
median_drym_pruef3 <- lapply(drym_pruef3, median, na.rm=T)
median_drym_pruef4 <- lapply(drym_pruef4, median, na.rm=T)
median_drym_jki_shelter_1 <- lapply(drym_jki_shelter_1, median, na.rm=T)
median_drym_jki_shelter_2 <- lapply(drym_jki_shelter_2, median, na.rm=T)
```

#### greenhouse trials (only check cultivars)
```{r calculate drym: greenhouse trials (only check cultivars)}
drym_pruef1_check <- func_calc_drym(pruef1_relSY_check, pruef1_relSY_median_check, cultivar_names=check_names)
drym_pruef2_check <- func_calc_drym(pruef2_relSY_check, pruef2_relSY_median_check, cultivar_names=check_names)
drym_pruef3_check <- func_calc_drym(pruef3_relSY_check, pruef3_relSY_median_check, cultivar_names=check_names)
drym_pruef4_check <- func_calc_drym(pruef4_relSY_check, pruef4_relSY_median_check, cultivar_names=check_names)
drym_jki_shelter_1_check <- func_calc_drym(jki_shelter_1_relSY_check, jki_shelter_1_relSY_median_check, cultivar_names=check_names)
drym_jki_shelter_2_check <- func_calc_drym(jki_shelter_2_relSY_check, jki_shelter_2_relSY_median_check, cultivar_names=check_names)

# median of DRYM per cultivar
median_drym_pruef1_check <- lapply(drym_pruef1_check, median, na.rm=T)
median_drym_pruef2_check <- lapply(drym_pruef2_check, median, na.rm=T)
median_drym_pruef3_check <- lapply(drym_pruef3_check, median, na.rm=T)
median_drym_pruef4_check <- lapply(drym_pruef4_check, median, na.rm=T)
median_drym_jki_shelter_1_check <- lapply(drym_jki_shelter_1_check, median, na.rm=T)
median_drym_jki_shelter_2_check <- lapply(drym_jki_shelter_2_check, median, na.rm=T)
```

#### field trials (all cultivars)
```{r calculate drym: field trials (all cultivars)}
drym_mpi_field_2011 <- func_calc_drym(mpi_field_2011_relSY, mpi_field_2011_relSY_median)
drym_mpi_field_2012 <- func_calc_drym(mpi_field_2012_relSY, mpi_field_2012_relSY_median)
drym_mpi_field_2013 <- func_calc_drym(mpi_field_2013_relSY, mpi_field_2013_relSY_median)
drym_jki_field_2012 <- func_calc_drym(jki_field_2012_relSY, jki_field_2012_relSY_median)
drym_jki_field_2013 <- func_calc_drym(jki_field_2013_relSY, jki_field_2013_relSY_median)
drym_dethlingen_2011 <- func_calc_drym(dethlingen_2011_relSY, dethlingen_2011_relSY_median)
drym_dethlingen_2012 <- func_calc_drym(dethlingen_2012_relSY, dethlingen_2012_relSY_median)
drym_dethlingen_2013 <- func_calc_drym(dethlingen_2013_relSY, dethlingen_2013_relSY_median)

# median of DRYM per cultivar
median_drym_mpi_field_2011 <- lapply(drym_mpi_field_2011, median, na.rm=T)
median_drym_mpi_field_2012 <- lapply(drym_mpi_field_2012, median, na.rm=T)
median_drym_mpi_field_2013 <- lapply(drym_mpi_field_2013, median, na.rm=T)
median_drym_jki_field_2012 <- lapply(drym_jki_field_2012, median, na.rm=T)
median_drym_jki_field_2013 <- lapply(drym_jki_field_2013, median, na.rm=T)
median_drym_dethlingen_2011 <- lapply(drym_dethlingen_2011, median, na.rm=T)
median_drym_dethlingen_2012 <- lapply(drym_dethlingen_2012, median, na.rm=T)
median_drym_dethlingen_2013 <- lapply(drym_dethlingen_2013, median, na.rm=T)
```

#### field trials (only check cultivars)
```{r calculate drym: field trials (only check cultivars)}
drym_mpi_field_2011_check <- func_calc_drym(mpi_field_2011_relSY_check, mpi_field_2011_relSY_median_check, cultivar_names=check_names)
drym_mpi_field_2012_check <- func_calc_drym(mpi_field_2012_relSY_check, mpi_field_2012_relSY_median_check, cultivar_names=check_names)
drym_mpi_field_2013_check <- func_calc_drym(mpi_field_2013_relSY_check, mpi_field_2013_relSY_median_check, cultivar_names=check_names)
drym_jki_field_2012_check <- func_calc_drym(jki_field_2012_relSY_check, jki_field_2012_relSY_median_check, cultivar_names=check_names)
drym_jki_field_2013_check <- func_calc_drym(jki_field_2013_relSY_check, jki_field_2013_relSY_median_check, cultivar_names=check_names)
drym_dethlingen_2011_check <- func_calc_drym(dethlingen_2011_relSY_check, dethlingen_2011_relSY_median_check, cultivar_names=check_names) # keine Check-Sorten enthalten!
drym_dethlingen_2012_check <- func_calc_drym(dethlingen_2012_relSY_check, dethlingen_2012_relSY_median_check, cultivar_names=check_names)
drym_dethlingen_2013_check <- func_calc_drym(dethlingen_2013_relSY_check, dethlingen_2013_relSY_median_check, cultivar_names=check_names)

# median of DRYM per cultivar
median_drym_mpi_field_2011_check <- lapply(drym_mpi_field_2011_check, median, na.rm=T)
median_drym_mpi_field_2012_check <- lapply(drym_mpi_field_2012_check, median, na.rm=T)
median_drym_mpi_field_2013_check <- lapply(drym_mpi_field_2013_check, median, na.rm=T)
median_drym_jki_field_2012_check <- lapply(drym_jki_field_2012_check, median, na.rm=T)
median_drym_jki_field_2013_check <- lapply(drym_jki_field_2013_check, median, na.rm=T)
median_drym_dethlingen_2011_check <- lapply(drym_dethlingen_2011_check, median, na.rm=T)
median_drym_dethlingen_2012_check <- lapply(drym_dethlingen_2012_check, median, na.rm=T)
median_drym_dethlingen_2013_check <- lapply(drym_dethlingen_2013_check, median, na.rm=T)
```

### Plot DRYM
#### test trials 
```{r plot DRYM: test trials}
drym_test_trials <- rbind(as.data.frame(median_drym_mpi_test_1_2), as.data.frame(median_drym_mpi_test_2), 
                         as.data.frame(median_drym_jki_test_1), as.data.frame(median_drym_jki_test_2))

drym_test_trials_melt <- melt(drym_test_trials)
colnames(drym_test_trials_melt) <- c("cultivar", "drym")

pdf("figures/drym_test_trials_check_cultivars.pdf", width=6, height=6)
par(mar=c(3, 4.5, 2, 0.5))
boxplot(drym_test_trials_melt$drym ~ drym_test_trials_melt$cultivar, 
        main="DRYM using 4 greenhouse trials", ylab="DRYM")
abline(h=0, col="red", lwd=2)
dev.off()

###########################################################################

# only 3 test trails that are used for RNA-Seq
drym_test_trials_pub <- rbind(as.data.frame(median_drym_mpi_test_1_2), as.data.frame(median_drym_mpi_test_2), 
                         as.data.frame(median_drym_jki_test_1))
drym_test_trials_pub_melt <- melt(drym_test_trials_pub)
colnames(drym_test_trials_pub_melt) <- c("cultivar", "drym")

pdf("figures/drym_test_trials_check_cultivars_pub.pdf", width=6, height=6)
par(mar=c(3, 4.5, 2, 0.5))
boxplot(drym_test_trials_pub_melt$drym ~ drym_test_trials_pub_melt$cultivar, 
        main="DRYM using 3 greenhouse trials for publication", ylab="DRYM")
abline(h=0, col="red", lwd=2)
dev.off()
```

#### field trials (all cultivars)
```{r plot DRYM: field trials (all cultivars)}
drym_feld_all <- rbind( as.data.frame(median_drym_mpi_field_2011),
                        as.data.frame(median_drym_mpi_field_2012),
                        as.data.frame(median_drym_mpi_field_2013),
                        as.data.frame(median_drym_jki_field_2012),
                        as.data.frame(median_drym_jki_field_2013),
                        as.data.frame(median_drym_dethlingen_2011),
                        as.data.frame(median_drym_dethlingen_2012),
                        as.data.frame(median_drym_dethlingen_2013))
  
#cultivar_names_all_8 <- rep(c("Albatros", "Alegria", "Burana", "Desiree", "Eldena", "Eurobravo", "Euroflora", "Euronova",  "Euroresa", "Eurostarch", "Eurotango", "Golf", "Jasia", "Jumbo", "Karlena", "Kiebitz", "Kolibri", "Kormoran", "Kuras", "Logo", "Maxi", "Maxilla", "Milva", "Pirol", "Power", "Priamos", "Ramses", "Saturna", "Sibu", "Sommergold", "Tomba", "Tomensa", "Ulme", "Verdi"), 8)

drym_feld_all_melt <- melt(drym_feld_all)
colnames(drym_feld_all_melt) <- c("cultivar", "drym")

pdf("figures/drym_feld_all_cultivars.pdf", width=8, height=6)
par(mar=c(6, 4.5, 0.5, 0.5))
boxplot(drym_feld_all_melt$drym ~ drym_feld_all_melt$cultivar, las=2)
abline(h=0, col="red", lwd=2)

# order by median
drym_feld_bymedian <- with(drym_feld_all_melt, reorder(cultivar, -drym, median, na.rm=T))
boxplot(drym ~ drym_feld_bymedian, data=drym_feld_all_melt, las=2)
abline(h=0, col="red", lwd=2)
dev.off()

# http://stackoverflow.com/questions/3765950/sorting-a-boxplot-based-on-median-value

# ANOVA to check influcence of factor cultivar on DRYM
summary(aov(drym_feld_all_melt$drym ~ drym_feld_all_melt$cultivar))
```


#### field trials with EARLY/LATE stress (all cultivars) --> 6 experiments
```{r plot DRYM: field trials with EARLY/LATE stress (all cultivars)}
drym_feld_all_early_stress <- rbind(as.data.frame(median_drym_mpi_field_2011), 
                                as.data.frame(median_drym_mpi_field_2012), 
                                as.data.frame(median_drym_jki_field_2012),
                                as.data.frame(median_drym_jki_field_2013),
                                as.data.frame(median_drym_dethlingen_2011),
                                as.data.frame(median_drym_dethlingen_2012))

drym_feld_all_late_stress <- rbind(as.data.frame(median_drym_mpi_field_2013), as.data.frame(median_drym_dethlingen_2013))

drym_feld_all_early_stress_melt <- melt(drym_feld_all_early_stress)
colnames(drym_feld_all_early_stress_melt) <- c("cultivar", "drym")

pdf("figures/drym_feld_all_cultivars_early_stress.pdf", width=6, height=6)
par(mar=c(6, 4.5, 0.5, 0.5))
boxplot(drym_feld_all_early_stress_melt$drym ~ drym_feld_all_early_stress_melt$cultivar, las=2, ylab="DRYM")
abline(h=0, col="red", lwd=2)

# order by median
drym_feld_early_stress_bymedian <- with(drym_feld_all_early_stress_melt, reorder(cultivar, -drym, median, na.rm=T))
boxplot(drym ~ drym_feld_early_stress_bymedian, data=drym_feld_all_early_stress_melt, las=2, ylab="DRYM")
abline(h=0, col="red", lwd=2)
dev.off()

# print out median drym values per cultivar for early stress field trials
# aggregate(drym_feld_all_early_stress_melt$drym, by=list(drym_feld_all_early_stress_melt$cultivar), median, na.rm=T)
drym_feld_all_early_stress_median <- aggregate(drym_feld_all_early_stress_melt$drym, 
                                               by=list(drym_feld_all_early_stress_melt$cultivar), median, na.rm=T)
write.table(drym_feld_all_early_stress_median, "output/drym_feld_early_stress_median.txt", sep="\t")

# ANOVA to check influcence of factor cultivar on DRYM
summary(aov(drym_feld_all_early_stress_melt$drym ~ drym_feld_all_early_stress_melt$cultivar))


# for phd-thesis
# change cultivar names to IDs!
levels(drym_feld_all_early_stress_melt$cultivar) <- cultivar_all_ids
# order by median
drym_feld_early_stress_bymedian <- with(drym_feld_all_early_stress_melt, reorder(cultivar, -drym, median, na.rm=T))

# pdf("~/work/Doktorarbeit/figures/drym_feld_all_cultivars_early_stress.pdf", width=10, height=6)
# par(mar=c(5, 4.5, 0.5, 0.5))
# boxplot(drym ~ drym_feld_early_stress_bymedian, data=drym_feld_all_early_stress_melt, las=2, ylab="DRYM", cex.lab=1.4, cex.axis=1.2)
# abline(h=0, col="red", lwd=2)
# dev.off()
```


#### field trials (only check cultivars)
```{r plot DRYM: field trials (only check cultivars)}
drym_feld_check <- rbind(as.data.frame(median_drym_mpi_field_2011_check), 
                     as.data.frame(median_drym_mpi_field_2012_check), 
                     as.data.frame(median_drym_mpi_field_2013_check), 
                     as.data.frame(median_drym_jki_field_2012_check),
                     as.data.frame(median_drym_jki_field_2013_check),
                     as.data.frame(median_drym_dethlingen_2011_check),
                     as.data.frame(median_drym_dethlingen_2012_check),
                     as.data.frame(median_drym_dethlingen_2013_check))

drym_feld_check_melt <- melt(drym_feld_check)
colnames(drym_feld_check_melt) <- c("cultivar", "drym")


pdf("figures/drym_feld_check_cultivars.pdf", width=6, height=6)
par(mar=c(3, 4.5, 2, 0.5))
boxplot(drym_feld_check_melt$drym ~ drym_feld_check_melt$cultivar, main="DRYM using all 8 field trials", ylab="DRYM")
abline(h=0, col="red", lwd=2)
dev.off()

###########################################################################

# only 3 trials for publication

drym_feld_check_pub <- rbind(as.data.frame(median_drym_mpi_field_2011_check), 
                     as.data.frame(median_drym_mpi_field_2012_check),
                     as.data.frame(median_drym_jki_field_2012_check))

drym_feld_check_pub_melt <- melt(drym_feld_check_pub)
colnames(drym_feld_check_pub_melt) <- c("cultivar", "drym")

# reorder cultivar factor (Milva, Alegria, Desiree, Saturna)
drym_feld_check_pub_melt$cultivar <- factor(drym_feld_check_pub_melt$cultivar, 
                                            levels = c("Milva", "Alegria", "Desiree", "Saturna"))

pdf("figures/drym_feld_check_cultivars_pub.pdf", width = 6, height = 6)
par(mar = c(3, 4.5, 2, 0.5))
boxplot(drym_feld_check_pub_melt$drym ~ drym_feld_check_pub_melt$cultivar, 
        main = "DRYM using 3 field trials for publication", ylab = "DRYM")
abline(h = 0, col = "red", lwd = 2)
dev.off()


# for phd-thesis:
#pdf("~/work/Doktorarbeit/figures/drym_feld_check_cultivars_pub.pdf", width=6, height=6)
par(mar=c(2.5, 4.5, 0.5, 0.5))
boxplot(drym_feld_check_pub_melt$drym ~ drym_feld_check_pub_melt$cultivar, ylab="DRYM", cex.lab=1.4, cex.axis=1.2)
abline(h=0, col="red", lwd=2)
#dev.off()
```


```{r plot DRYM: field trials (only check cultivars) PUBLICATION, message=FALSE}
# for publication:

pdf("../../TROST/Manuskripte/tba/drym_feld_check_cultivars_pub.pdf", width=6.2, height=6)
par(mar=c(2.5, 4.5, 0.5, 0.5))
boxplot(drym_feld_check_pub_melt$drym ~ drym_feld_check_pub_melt$cultivar, 
        ylab = "DRYM", cex.lab = 2, cex.axis = 1.5, lwd = 2, xaxt = "n")
axis(1, at = 1:4, tick = T, cex.axis = 1.7,
     labels = levels(drym_feld_check_pub_melt$cultivar))
abline(h = 0, col = "red", lwd = 2)
dev.off()

# svg("../../TROST/Manuskripte/tba/drym_feld_check_cultivars_pub.svg", width=6, height=6)
par(mar=c(2.5, 4.5, 0.5, 0.5))
boxplot(drym_feld_check_pub_melt$drym ~ drym_feld_check_pub_melt$cultivar, 
        ylab = "DRYM", cex.lab = 1.6, cex.axis = 1.4, lwd = 2)
abline(h = 0, col = "red", lwd = 2)
#dev.off()

# Using Arial in R figures destined for PLOS ONE
# http://www.fromthebottomoftheheap.net/2013/09/09/preparing-figures-for-plos-one-with-r/
# library("extrafont")
font_import() # done as admin

## When it is finished, look at the fonts it has found
fonts()

loadfonts() ## for pdf()
## or
loadfonts(device = "postscript") ## for postscript()

setEPS()
#postscript("../../TROST/Manuskripte/tba/drym_feld_check_cultivars_pub_2.eps", width=6, height=6, family="Arial")
par(mar=c(2.5, 4.5, 0.5, 0.5))
boxplot(drym_feld_check_pub_melt$drym ~ drym_feld_check_pub_melt$cultivar, ylab="DRYM", cex.lab=1.6, cex.axis=1.4, lwd=2)
abline(h=0, col="red", lwd=2)
#dev.off()
```


```{r ORIGINAL feld check pub}
# using MEDIAN per experiment
drym_feld_check_pub_melt_anova <- aov(drym ~ cultivar, data=drym_feld_check_pub_melt)
summary(drym_feld_check_pub_melt_anova)
TukeyHSD(drym_feld_check_pub_melt_anova)

tuk2 <- glht(drym_feld_check_pub_melt_anova, linfct = mcp(cultivar = "Tukey"))
summary(tuk2)
tuk.cld2 <- cld(tuk2)   # letter-based display
opar <- par(mai=c(1,1,1.5,1))
plot(tuk.cld2)
par(opar)
```


### using ALL values per experiment (append two lists)
```{r using ALL values per experiment}
pub_append1 <- appendList(drym_mpi_field_2011_check,drym_mpi_field_2012_check)
pub_append2 <- appendList(drym_jki_field_2012_check, pub_append1)

n.obs_pub <- sapply(pub_append2, length)
seq.max_pub <- seq_len(max(n.obs_pub))
mat_pub <- as.data.frame(sapply(pub_append2, "[", i = seq.max_pub))
class(mat_pub)

sum(is.na(mat_pub))
  
mat_melt_pub <- melt(mat_pub)
head(mat_melt_pub)
# remove NA rows
mat_melt_na_pub <- which(is.na(mat_melt_pub$value))
mat_melt_pub2 <- mat_melt_pub[-mat_melt_na_pub,]
dim(mat_melt_pub2)
colnames(mat_melt_pub2) <- c("cultivar", "drym")

# ANOVA to check influcence of factor cultivar on DRYM
mat_melt_pub2_anova <- aov(drym ~ cultivar, data=mat_melt_pub2)
summary(mat_melt_pub2_anova)
TukeyHSD(mat_melt_pub2_anova)


tuk <- glht(mat_melt_pub2_anova, linfct = mcp(cultivar = "Tukey"))
summary(tuk)
tuk.cld <- cld(tuk)   # letter-based display
opar <- par(mai=c(1,1,1.5,1))
plot(tuk.cld)
par(opar)

# boxplot
boxplot(mat_melt_pub2$drym ~ mat_melt_pub2$cultivar, main="DRYM using 3 field trials for publication", ylab="DRYM")
```



```{r check for outlier}
drym_feld_check_pub_single <- rbind(as.data.frame(drym_mpi_field_2011_check), 
                                   as.data.frame(drym_mpi_field_2012_check),
                                   as.data.frame(drym_jki_field_2012_check))
drym_feld_check_pub_single_melt <- melt(drym_feld_check_pub_single)
dim(drym_feld_check_pub_single_melt)
trials_feld_check_pub_single <- rep( c( rep("MPI 2011", 8), rep("MPI 2012", 8), rep("JKI 2012", 2)), 4)
length(drym_feld_check_pub_single_melt)
drym_feld_check_pub_single_melt <- cbind(drym_feld_check_pub_single_melt, trials=trials_feld_check_pub_single)
head(drym_feld_check_pub_single_melt)

# mean
drym_feld_check_pub_mean <- aggregate(drym_feld_check_pub_single_melt$value, 
                                          by=list(drym_feld_check_pub_single_melt$trials, 
                                                  drym_feld_check_pub_single_melt$variable), 
                                          mean, na.rm=T)

drym_feld_check_pub_sd <- aggregate(drym_feld_check_pub_single_melt$value, 
                                        by=list(drym_feld_check_pub_single_melt$trials, 
                                                drym_feld_check_pub_single_melt$variable), 
                                        sd, na.rm=T)

upper <- drym_feld_check_pub_mean$x + 2 * drym_feld_check_pub_sd$x
lower <- drym_feld_check_pub_mean$x - 2 * drym_feld_check_pub_sd$x

drym_mpi_field_2012_check$Alegria
mpi_field_2012[which(mpi_field_2012$cultivar=="Alegria" & mpi_field_2012$treatment=="drought stress"),]
# maybe 1170195 is an outlier

#############################################################################

drym_mpi_field_2011_check_new_melt <- melt(as.data.frame(drym_mpi_field_2011_check))
boxplot(drym_mpi_field_2011_check_new_melt$value ~ drym_mpi_field_2011_check_new_melt$variable, main="MPI field 2011", ylab="DRYM")

drym_mpi_field_2012_check_new_melt <- melt(as.data.frame(drym_mpi_field_2012_check))
boxplot(drym_mpi_field_2012_check_new_melt$value ~ drym_mpi_field_2012_check_new_melt$variable, main="MPI field 2012", ylab="DRYM")
```



#### 6 greenhouse trials (all cultivars)
```{r plot DRYM: 6 greenhouse trials (all cultivars)}
drym_greenhouse_all <- rbind(as.data.frame(median_drym_pruef1),
                               as.data.frame(median_drym_pruef2), 
                               as.data.frame(median_drym_pruef3), 
                               as.data.frame(median_drym_pruef4), 
                               as.data.frame(median_drym_jki_shelter_1),
                               as.data.frame(median_drym_jki_shelter_2))

drym_greenhouse_all_melt <- melt(drym_greenhouse_all)
colnames(drym_greenhouse_all_melt) <- c("cultivar", "drym")

# ANOVA to check influcence of factor cultivar on DRYM
summary(aov(drym_greenhouse_all_melt$drym ~ drym_greenhouse_all_melt$cultivar))

pdf("figures/drym_greenhouse_all_cultivars.pdf", width=6, height=6)
par(mar=c(6, 4.5, 0.5, 0.5))
boxplot(drym_greenhouse_all_melt$drym ~ drym_greenhouse_all_melt$cultivar, las=2, ylab="DRYM")
abline(h=0, col="red", lwd=2)

# order by median
drym_greenhouse_bymedian <- with(drym_greenhouse_all_melt, reorder(cultivar, -drym, median, na.rm=T))
boxplot(drym ~ drym_greenhouse_bymedian, data=drym_greenhouse_all_melt, las=2, ylab="DRYM")
abline(h=0, col="red", lwd=2)
dev.off()
```

#### 6 greenhouse trials (check cultivars)
```{r plot DRYM: 6 greenhouse trials (check cultivars)}
drym_greenhouse_check <- rbind(as.data.frame(median_drym_pruef1_check),
                               as.data.frame(median_drym_pruef2_check), 
                               as.data.frame(median_drym_pruef3_check), 
                               as.data.frame(median_drym_pruef4_check), 
                               as.data.frame(median_drym_jki_shelter_1_check),
                               as.data.frame(median_drym_jki_shelter_2_check))

drym_greenhouse_check_melt <- melt(drym_greenhouse_check)
colnames(drym_greenhouse_check_melt) <- c("cultivar", "drym")

pdf("figures/drym_greenhouse_check_cultivars.pdf", width=6, height=6)
par(mar=c(3, 4.5, 0.5, 0.5))
boxplot(drym_greenhouse_check_melt$drym ~ drym_greenhouse_check_melt$cultivar, ylab="DRYM")
abline(h=0, col="red", lwd=2)
dev.off()

####################################################################################

# including also greenhouse TEST trials
drym_greenhouse_test <- rbind(as.data.frame(median_drym_pruef1_check),
                              as.data.frame(median_drym_pruef2_check), 
                              as.data.frame(median_drym_pruef3_check), 
                              as.data.frame(median_drym_pruef4_check), 
                              as.data.frame(median_drym_jki_shelter_1_check),
                              as.data.frame(median_drym_jki_shelter_2_check),
                              as.data.frame(median_drym_mpi_test_1_2),
                              as.data.frame(median_drym_mpi_test_2),
                              as.data.frame(median_drym_jki_test_1),
                              as.data.frame(median_drym_jki_test_2))

drym_greenhouse_test_melt <- melt(drym_greenhouse_test)
colnames(drym_greenhouse_test_melt) <- c("cultivar", "drym")

pdf("figures/drym_greenhouse_and_test_trials_check_cultivars.pdf", width=6, height=6)
par(mar=c(3, 4.5, 0.5, 0.5))
boxplot(drym_greenhouse_test_melt$drym ~ drym_greenhouse_test_melt$cultivar, ylab="DRYM")
abline(h=0, col="red", lwd=2)
dev.off()
```


#### field trials (all cultivars)
```{r ORIGINAL DRYM: field trials (all cultivars)}
feld_append1 <- appendList(drym_mpi_field_2011,drym_mpi_field_2012)
feld_append2 <- appendList(drym_jki_field_2012,drym_jki_field_2013)
feld_append3 <- appendList(drym_dethlingen_2011, drym_dethlingen_2012)
feld_append4 <- appendList(drym_mpi_field_2013,drym_dethlingen_2013)
feld_append5 <- appendList(feld_append1, feld_append2)
feld_append6 <- appendList(feld_append3, feld_append4)
feld_append7 <- appendList(feld_append5, feld_append6)

n.obs <- sapply(feld_append7, length)
seq.max <- seq_len(max(n.obs))
mat <- as.data.frame(sapply(feld_append7, "[", i = seq.max))
class(mat)

sum(is.na(mat))
dim(mat)[1]*dim(mat)[2]
1088-305
# makes 783 -> df(error)=748 (because df(cultivar)=33 and df(SI)=1, df(NSY)=1)
  
mat_melt <- melt(mat)
head(mat_melt)
# remove NA rows
mat_melt_na <- which(is.na(mat_melt$value))
mat_melt2 <- mat_melt[-mat_melt_na,]
dim(mat_melt2)
colnames(mat_melt2) <- c("cultivar", "drym")

# ANOVA to check influcence of factor cultivar on DRYM
summary(aov(mat_melt2$drym ~ mat_melt2$cultivar))

# print out median drym values per cultivar for all field trials
aggregate(mat_melt2$drym, by=list(mat_melt2$cultivar), median, na.rm=T)

aggregate(drym_feld_all_melt$drym, by=list(drym_feld_all_melt$cultivar), median, na.rm=T)

plot(aggregate(mat_melt2$drym, by=list(mat_melt2$cultivar), median, na.rm=T)$x,
     aggregate(drym_feld_all_melt$drym, by=list(drym_feld_all_melt$cultivar), median, na.rm=T)$x)
```


#### field trials with early stress (all cultivars)
```{r ORIGINAL DRYM: field trials with early stress (all cultivars)}
early_append1 <- appendList(drym_mpi_field_2011,drym_mpi_field_2012)
early_append2 <- appendList(drym_jki_field_2012,drym_jki_field_2013)
early_append3 <- appendList(drym_dethlingen_2011, drym_dethlingen_2012)
early_append4 <- appendList(early_append1, early_append2)
early_append5 <- appendList(early_append3, early_append4)


n.obs_early <- sapply(early_append5, length)
seq.max_early <- seq_len(max(n.obs_early))
mat_early <- as.data.frame(sapply(early_append5, "[", i = seq.max_early))
class(mat_early)

sum(is.na(mat_early))
dim(mat_early)[1]*dim(mat_early)[2]
  
mat_melt_early <- melt(mat_early)
head(mat_melt_early)
# remove NA rows
mat_melt_na_early <- which(is.na(mat_melt_early$value))
mat_melt_early2 <- mat_melt_early[-mat_melt_na_early,]
dim(mat_melt_early2)
colnames(mat_melt_early2) <- c("cultivar", "drym")

# ANOVA to check influcence of factor cultivar on DRYM
fit_early <- aov(drym ~ cultivar, data=mat_melt_early2)
summary(fit_early)

# head(TukeyHSD(fit_early))

tuk_early <- glht(fit_early, linfct = mcp(cultivar = "Tukey"))
# summary(tuk_early)
# tuk.cld_early <- cld(tuk_early)   # letter-based display
# opar <- par(mai=c(1,1,1.5,1))
# plot(tuk.cld_early)
# par(opar)

# print out median drym values per cultivar for all field trials
aggregate(mat_melt_early2$drym, by=list(mat_melt_early2$cultivar), median, na.rm=T)

aggregate(drym_feld_all_early_stress_melt$drym, by=list(drym_feld_all_early_stress_melt$cultivar), median, na.rm=T)
```


```{r ORIGINAL DRYM: 6 greenhouse trials (all cultivars)}
gh_append1 <- appendList(drym_pruef1, drym_pruef2)
gh_append2 <- appendList(drym_pruef3, drym_pruef4)
gh_append3 <- appendList(drym_jki_shelter_1, drym_jki_shelter_2)
gh_append4 <- appendList(gh_append1, gh_append2)
gh_append5 <- appendList(gh_append4, gh_append3)

n.obs_gh <- sapply(gh_append5, length)
seq.max_gh <- seq_len(max(n.obs_gh))
mat_gh <- as.data.frame(sapply(gh_append5, "[", i = seq.max_gh))
class(mat_gh)

sum(is.na(mat_gh))
dim(mat_gh)[1]*dim(mat_gh)[2]
  
mat_melt_gh <- melt(mat_gh)
head(mat_melt_gh)
mat_melt_na_gh <- which(is.na(mat_melt_gh$value))
mat_melt_gh2 <- mat_melt_gh[-mat_melt_na_gh,]
dim(mat_melt_gh2)
colnames(mat_melt_gh2) <- c("cultivar", "drym")

# ANOVA to check influcence of factor cultivar on DRYM
summary(aov(mat_melt_gh2$drym ~ mat_melt_gh2$cultivar))

# print out median drym values per cultivar for all greenhouse trials
aggregate(mat_melt_gh2$drym, by=list(mat_melt_gh2$cultivar), median, na.rm=T)
```

#### plot starch yield vs DRYM
```{r plot starch yield vs DRYM}
mpi_field_2011_control <- subset(mpi_field_2011, mpi_field_2011$treatment=="control")
mpi_field_2012_control <- subset(mpi_field_2012, mpi_field_2012$treatment=="control")
jki_field_2012_control <- subset(jki_field_2012, jki_field_2012$treatment=="control")
jki_field_2013_control <- subset(jki_field_2013, jki_field_2013$treatment=="control")
dethlingen_2011_control <- subset(dethlingen_2011, dethlingen_2011$treatment=="control")
dethlingen_2012_control <- subset(dethlingen_2012, dethlingen_2012$treatment=="control")

mpi_field_2011_control_starch_yield_median <- median(mpi_field_2011_control$starch_yield_g_per_plant, na.rm=T)
mpi_field_2012_control_starch_yield_median <- median(mpi_field_2012_control$starch_yield_g_per_plant, na.rm=T)
jki_field_2012_control_starch_yield_median <- median(jki_field_2012_control$starch_yield_g_per_plant, na.rm=T)
jki_field_2013_control_starch_yield_median <- median(jki_field_2013_control$starch_yield_g_per_plant, na.rm=T)
dethlingen_2011_control_starch_yield_median <- median(dethlingen_2011_control$starch_yield_g_per_plant, na.rm=T)
dethlingen_2012_control_starch_yield_median <- median(dethlingen_2012_control$starch_yield_g_per_plant, na.rm=T)

starch_yield_control_feld_all_early_stress <- rbind(
  aggregate(mpi_field_2011_control$starch_yield_g_per_plant, by=list(mpi_field_2011_control$cultivar), median, na.rm=T),
aggregate(mpi_field_2012_control$starch_yield_g_per_plant, by=list(mpi_field_2012_control$cultivar), median, na.rm=T),
aggregate(jki_field_2012_control$starch_yield_g_per_plant, by=list(jki_field_2012_control$cultivar), median, na.rm=T),
aggregate(jki_field_2013_control$starch_yield_g_per_plant, by=list(jki_field_2013_control$cultivar), median, na.rm=T),
aggregate(dethlingen_2011_control$starch_yield_g_per_plant, by=list(dethlingen_2011_control$cultivar), median, na.rm=T),
aggregate(dethlingen_2012_control$starch_yield_g_per_plant, by=list(dethlingen_2012_control$cultivar), median, na.rm=T))

norm_starch_yield_control_feld_all_early_stress <- c(
  aggregate(mpi_field_2011_control$starch_yield_g_per_plant, by=list(mpi_field_2011_control$cultivar), median, na.rm=T)$x/mpi_field_2011_control_starch_yield_median,
aggregate(mpi_field_2012_control$starch_yield_g_per_plant, by=list(mpi_field_2012_control$cultivar), median, na.rm=T)$x/mpi_field_2012_control_starch_yield_median,
aggregate(jki_field_2012_control$starch_yield_g_per_plant, by=list(jki_field_2012_control$cultivar), median, na.rm=T)$x/jki_field_2012_control_starch_yield_median,
aggregate(jki_field_2013_control$starch_yield_g_per_plant, by=list(jki_field_2013_control$cultivar), median, na.rm=T)$x/jki_field_2013_control_starch_yield_median,
aggregate(dethlingen_2011_control$starch_yield_g_per_plant, by=list(dethlingen_2011_control$cultivar), median, na.rm=T)$x/dethlingen_2011_control_starch_yield_median,
aggregate(dethlingen_2012_control$starch_yield_g_per_plant, by=list(dethlingen_2012_control$cultivar), median, na.rm=T)$x/dethlingen_2012_control_starch_yield_median)

norm_starch_yield_control_feld_all_early_stress_median <- aggregate(norm_starch_yield_control_feld_all_early_stress, by=list(starch_yield_control_feld_all_early_stress$Group.1), median, na.rm=T)

# par(mar=c(5, 5, 1, 0.5))
# plot(starch_yield_control_feld_all_early_stress_median$x, drym_feld_all_early_stress_median$x, pch=19, cex=1.5, xlab="starch yield in g per plant (control)", ylab="DRYM", cex.lab=1.5, cex.axis=1.2)
# 
# plot(norm_starch_yield_control_feld_all_early_stress_median$x, drym_feld_all_early_stress_median$x, pch=19, cex=1.5, xlab="normalized starch yield (control)", ylab="DRYM", cex.lab=1.5, cex.axis=1.2)
# abline(lm(drym_feld_all_early_stress_median$x ~ norm_starch_yield_control_feld_all_early_stress_median$x), col="grey", lwd=2)
# cor.test(norm_starch_yield_control_feld_all_early_stress_median$x, drym_feld_all_early_stress_median$x)
```


## further analysis of 6 experiments for publication: G1, G2, G3, F1, F3, F4
### starch yield: combine mean and sd
```{r starch yield: combine mean and sd}
mpi_test_1_2_mean_sd <- func_combine_mean_sd(mpi_test_1_2, variable_name = "starch_yield_g_per_plant")

mpi_test_2_mean_sd <- func_combine_mean_sd(mpi_test_2, variable_name = "starch_yield_g_per_plant")

jki_test_1_mean_sd <- func_combine_mean_sd(jki_test_1, variable_name = "starch_yield_g_per_plant")

mpi_field_2011_check_sy_mean_sd <- func_combine_mean_sd(mpi_field_2011_check,
                                                        variable_name = "starch_yield_g_per_plant")

mpi_field_2012_check_sy_mean_sd <- func_combine_mean_sd(mpi_field_2012_check, 
                                                        variable_name = "starch_yield_g_per_plant")

jki_field_2012_check_sy_mean_sd <- func_combine_mean_sd(jki_field_2012_check, 
                                                        variable_name = "starch_yield_g_per_plant")
```


### starch_yield_g_per_plant: compare control and stress by t-test
```{r starch_yield_g_per_plant: compare control and stress by t-test}
starch_yield_ttest_res <- c(func_ttest_treatment2(mpi_test_1_2, variable_name = "starch_yield_g_per_plant"), #G1
                            func_ttest_treatment2(mpi_test_2, variable_name = "starch_yield_g_per_plant"), #G2
                            func_ttest_treatment2(jki_test_1, variable_name = "starch_yield_g_per_plant"), #G3
                            func_ttest_treatment2(mpi_field_2011_check, variable_name = "starch_yield_g_per_plant"), #F1
                            func_ttest_treatment2(mpi_field_2012_check, variable_name = "starch_yield_g_per_plant"), #F3
                            func_ttest_treatment2(jki_field_2012_check, variable_name = "starch_yield_g_per_plant")) #F4
```


### starch yield: combine mean and sd results of all 6 experiments (for publication)
```{r starch yield: combine mean and sd results of all 6 experiments}

starch_yield_check_mean_sd <- rbind(mpi_test_1_2_mean_sd, #G1
                                    mpi_test_2_mean_sd, #G2
                                    jki_test_1_mean_sd, #G3
                                    mpi_field_2011_check_sy_mean_sd, #F1
                                    mpi_field_2012_check_sy_mean_sd, #F3
                                    jki_field_2012_check_sy_mean_sd) #F4

starch_yield_check_mean_sd$trial <- c( rep("G1", 4), rep("G2", 4), rep("G3", 4),
                                       rep("F1", 4), rep("F3", 4), rep("F4", 4))

starch_yield_check_mean_sd$percentage <- starch_yield_check_mean_sd$mean_drought_stress * 100 /
                                         starch_yield_check_mean_sd$mean_control

starch_yield_check_mean_sd$p_value <- starch_yield_ttest_res

pander(head(starch_yield_check_mean_sd))

write.table(starch_yield_check_mean_sd,
            "output/starch_yield_check_mean_sd.txt",
            sep="\t", quote=F, col.names = NA)
```

### combine ANOVA results for publication
```{r combine ANOVA results for publication}
# combine anova results of 6 experiments (for publication)
starch_yield_anova6 <- func_combine_anova_res6(mpi_test_1_2_anova,
                                               mpi_test_2_anova, 
                                               jki_test_1_anova,
                                               mpi_field_2011_check_anova,
                                               mpi_field_2012_check_anova,
                                               jki_field_2012_check_anova,
                                               "f_value","p_value", "treatment", "cultivar")

rownames(starch_yield_anova6) <- c("G1", "G2", "G3", "F1", "F3", "F4")
pander(starch_yield_anova6)
write.table(starch_yield_anova6, "output/starch_yield_anova_pub.txt", sep="\t", quote=F, row.names = T, col.names = NA)


#### with interactions!

starch_yield_anova6_ia <- func_combine_anova_res6_ia(mpi_test_1_2_anova,
                                                     mpi_test_2_anova, 
                                                     jki_test_1_anova,
                                                     mpi_field_2011_check_anova,
                                                     mpi_field_2012_check_anova,
                                                     jki_field_2012_check_anova,
                                                     "f_value","p_value", "treatment", "cultivar")

rownames(starch_yield_anova6_ia) <- c("G1", "G2", "G3", "F1", "F3", "F4")
pander(starch_yield_anova6_ia)
write.table(starch_yield_anova6_ia, "output/starch_yield_anova_pub_with_ia.txt", sep="\t", quote=F, row.names = T, col.names = NA)
```


### save workspace
```{r save workspace}
save.image("yield_data.RData")
```
