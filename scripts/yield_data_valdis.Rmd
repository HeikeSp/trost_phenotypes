---
title: "Yield data analysis of VALDIS data"
author: "Heike Sprenger"
date: "Wednesday, February 17, 2016"
output:
  html_document:
    highlight: tango
    number_section: yes
    theme: cerulean
    toc: yes
    toc_depth: 4
---

# Set working directory  
```{r set working directory}
getwd()
#setwd("D:/work/repos/trost_phenotypes")
#setwd("~/work/repos/trost_phenotypes/")
```


# Load workspace, packages and scripts
```{r load workspace, message=FALSE}
# load packages
library(knitr)
library(ggplot2)
library(reshape)
library(pander)
library(multcomp)
library(extrafont)
library(plyr)
library(GGally)

# set options for pander
panderOptions('table.split.table', 200)

# set options for knitr
opts_chunk$set(fig.width=5, fig.height=5, cache=FALSE, highlight = TRUE, fig.show="asis")
opts_knit$set(root.dir = '../')

# load workspace
# load("yield_data_valdis.RData")
```


# Source R functions
```{r source R functions, include=FALSE}
source("../functions/names.R")
source("../functions/colors.R")
source("../functions/func_cv.R")
source("../functions/func_appendList.R")
source("../functions/func_anova_v2.R")
source("../functions/func_ttest.R")
source("../functions/func_aggregate_values.R")
source("../functions/func_modify_yield_data.R")
source("../functions/func_get_yield_data.R")
source("../functions/func_starch_yield_valdis.R")
source("../functions/func_calc_stress_index.R")
source("../functions/func_calc_relSY.R")
source("../functions/func_calc_drym.R")
source("../functions/func_calc_ssi.R")
source("../functions/func_venn_diagram.R")
source("../functions/func_pairs_plot.R")
```


# Get yield data (from phenotyper)
```{r get yield data}
yield_data <- func_get_yield_data(project = "valdis")

dim(yield_data)

pander(table(yield_data$culture))
pander(table(yield_data$culture, yield_data$attribute))

write.table(yield_data, "data/yield_data_valdis_raw.txt", sep="\t")
```


# Get plant number per plot
```{r get plant number per plot, eval=FALSE}
# plant_number <- func_get_plant_number(project = "valdis")
# 
# # remove duplicate entries
# plant_number_no_duplicates <- plant_number[!duplicated(plant_number),]
# 
# dim(plant_number_no_duplicates)
# table(plant_number_no_duplicates$culture)
```


# Modify yield data
## Change culture for experiments with two IDs
```{r change culture for experiments with two IDs}
table(yield_data$culture)

idx_72237 <- which(yield_data$culture == "72237")
idx_68713 <- which(yield_data$culture == "68713")

# culture 72237 belongs to JKI Shelter 2014 (68015)
yield_data$culture[idx_72237] <- "68015"

# culture 68713 belongs to MPI Field 2014 (67516)
yield_data$culture[idx_68713] <- "67516"

table(yield_data$culture)
```


## Change treatment name
```{r change treatment name}
yield_data$treatment_name <- yield_data$treatment
yield_data$treatment_name[which(yield_data$treatment == "169")] = "control"
yield_data$treatment_name[which(yield_data$treatment == "170")] = "drought stress"
yield_data$treatment_name[which(yield_data$treatment == "171")] = "control" # 50% nFK

# remove entries with 30% nFK (id: 172, from Dethlingen)
idx_172 <- which(yield_data$treatment == "172")
yield_data <- yield_data[-idx_172,]

# change class of treatment_name
yield_data$treatment_name <- as.factor(yield_data$treatment_name)
levels(yield_data$treatment_name)

table(yield_data$treatment_name)
```


## Change alias for cultivar names
```{r change alias for cultivar names}
idx_desiree <- which(grepl("^\\[St.D.n\\]", yield_data$name) | grepl("^\\[St.Desiree.n\\]", yield_data$name))
# remove Desiree entries
yield_data <- yield_data[-idx_desiree,]
dim(yield_data)

idx_ramses <- which(grepl("^\\[St.Ramses.n\\]", yield_data$name))
idx_euroresa <- which(grepl("^\\[St.Euroresa.n\\]", yield_data$name))
idx_albatros <- which(grepl("^\\[St.Albatros.n\\]", yield_data$name))

yield_data$alias[idx_ramses] <- "Ramses"
yield_data$alias[idx_euroresa] <- "Euroresa"
yield_data$alias[idx_albatros] <- "Albatros"

yield_data$alias <- as.factor(yield_data$alias)

#table(yield_data$alias, yield_data$culture)
```


## Replace "-666.66" by NA
```{r replace -666.66 by NA}
# change class of number
yield_data$number <- as.numeric(yield_data$number)

idx_missing <- which(yield_data$number=="-666.66")
yield_data$number[idx_missing] <- NA
```


## Remove duplicate entries
```{r remove duplicate entries}
#table(yield_data$measurement_date, yield_data$culture)
dim(yield_data)

idx_duplicates <- which(duplicated(yield_data[,-c(7,8)])) # column 7, 8: measurement date and time should be ignored

yield_data_no_duplicates <- yield_data[-idx_duplicates,]
dim(yield_data_no_duplicates)
# 14703 15

write.table(yield_data_no_duplicates, "data/yield_data_valdis_no_duplicates.txt", sep="\t")
```


## Find outlier
```{r find outlier}
# outlier?
idx_outlier <- which(yield_data_no_duplicates$number > 400)
pander(yield_data_no_duplicates[idx_outlier,])
yield_data_no_duplicates[idx_outlier, "plant_id"]

# remove them?
# entries with "999" as number belong to plants with FW = 0 --> change to NA
yield_data_no_duplicates$number[idx_outlier] <- NA
```


## Subsets for fw and sc
```{r subsets for fw and sc}
# starch content: sc
yield_data_sc <- subset(yield_data_no_duplicates, yield_data_no_duplicates$value_id == 190)
# fresh weight: fw
yield_data_fw <- subset(yield_data_no_duplicates, yield_data_no_duplicates$value_id == 188)
# starch yield: sy
yield_data_sy <- subset(yield_data_no_duplicates, yield_data_no_duplicates$value_id == 191)

range(yield_data_sc$number, na.rm = T)
range(yield_data_fw$number, na.rm = T)

hist(yield_data_sc$number, main = "starch content", breaks = 30, col = "grey")
hist(yield_data_fw$number, main = "fresh weight", breaks = 30, col = "grey")
hist(yield_data_sy$number, main = "starch yield", breaks = 30, col = "grey")
```


**to do: implement this procedure in modify function!**

# Experiments 2014
## JKI Field 2014: 67518
```{r JKI Field 2014: 67518}
yield_data_67518 <- subset(yield_data_no_duplicates, yield_data_no_duplicates$culture == "67518")

dim(yield_data_67518)

length(unique(yield_data_67518$line_id)) # 194
length(unique(yield_data_67518$alias)) # 194

# subsets for different attributes
yield_data_67518_fw <- subset(yield_data_67518,
                              yield_data_67518$value_id == "188")
yield_data_67518_sc <- subset(yield_data_67518,
                              yield_data_67518$value_id == "190")
# both 768 entries
```


## JKI Pot 2014: 68015 and 72237
```{r JKI Pot 2014: 68015 and 72237}
yield_data_68015 <- subset(yield_data_no_duplicates, yield_data_no_duplicates$culture %in% c("68015","72237"))

dim(yield_data_68015)

length(unique(yield_data_68015$line_id)) # 197
length(unique(yield_data_68015$alias)) # 197

setdiff(unique(yield_data_67518$alias), unique(yield_data_68015$alias))
setdiff(unique(yield_data_68015$alias), unique(yield_data_67518$alias))

# subsets for different attributes
yield_data_68015_fw <- subset(yield_data_68015,
                              yield_data_68015$value_id == "188")
yield_data_68015_sc <- subset(yield_data_68015,
                              yield_data_68015$value_id == "190")
# both 784 entries
```


## MPI Field 2014: 67516 and 68713
```{r MPI Field 2014: 67516 and 68713}
yield_data_67516 <- subset(yield_data_no_duplicates, yield_data_no_duplicates$culture %in% c("67516","68713"))

dim(yield_data_67516)

length(unique(yield_data_67516$line_id)) # 204
length(unique(yield_data_67516$alias)) # 204

# unique lines in MPI field trial 2014
setdiff(unique(yield_data_67516$alias), unique(yield_data_68015$alias)) 
setdiff(unique(yield_data_68015$alias), unique(yield_data_67516$alias))

# subsets for different attributes
yield_data_67516_fw <- subset(yield_data_67516,
                              yield_data_67516$value_id == "188")
yield_data_67516_sc <- subset(yield_data_67516,
                              yield_data_67516$value_id == "190")

# sc: 415
# fw: 414

# find duplicates
which(duplicated(yield_data_67516_sc$plant_id)) # 415
yield_data_67516_sc$plant_id[415]
# plant_id: 1503655

# remove duplicate entry
idx_remove_67516_sc <- which(yield_data_no_duplicates$plant_id == "1503655" & is.na(yield_data_no_duplicates$number)==T)
yield_data_no_duplicates <- yield_data_no_duplicates[-idx_remove_67516_sc,]
```


## MPI FGH 2014: 67199
```{r MPI FGH 2014: 67199}
yield_data_67199 <- subset(yield_data_no_duplicates, yield_data_no_duplicates$culture == "67199")

dim(yield_data_67199)

length(unique(yield_data_67199$line_id)) # 228
length(unique(yield_data_67199$alias)) # 228

# unique lines in MPI FGH trial 2014
setdiff(unique(yield_data_67199$alias), unique(yield_data_67516$alias))
# unique lines in MPI Field trial 2014
setdiff(unique(yield_data_67516$alias), unique(yield_data_67199$alias)) 

# subsets for different attributes
yield_data_67199_fw <- subset(yield_data_67199,
                              yield_data_67199$value_id == "188")
yield_data_67199_sc <- subset(yield_data_67199,
                              yield_data_67199$value_id == "190")

# fw: 1241
# sc: 1645

table(table(yield_data_67199_sc$plant_id))
#    1    2    3 
# 1017   32  186
# 186 entries were measured thrice! 
# calculate average of those repeated measurements of starch content (sc)

# calculate mean starch content per plant
yield_data_67199_sc_mean_per_plant <- ddply(yield_data_67199_sc, "plant_id", summarise,
                                            mean = mean(as.numeric(number), na.rm = T))
pander(head(yield_data_67199_sc_mean_per_plant))
dim(yield_data_67199_sc_mean_per_plant)
# 1241 --> equal to fw
```


## Venn diagram of lines cultivated in 4 different experiments 2014
```{r venn diagram of lines cultivated in 4 different experiments 2014}

venn_2014 <- func_venn_diagram_4(res1 = yield_data_67516$alias,
                    res2 = yield_data_67199$alias,
                    res3 = yield_data_67518$alias,
                    res4 = yield_data_68015$alias,
                    lab1 = "MPI Field 2014",
                    lab2 = "MPI FGH 2014",
                    lab3 = "JKI Field 2014",
                    lab4 = "JKI Pot 2014")

plot.new()
flog.threshold(ERROR)
grid.draw(venn_2014)

common_lines_2014 <- intersect(
  intersect(yield_data_67516$alias, yield_data_67199$alias),
  intersect(yield_data_67518$alias, yield_data_68015$alias))

common_lines_2014 <- sort(common_lines_2014)
length(common_lines_2014)
```

## Define desired subset of lines for further analysis
**take all 192 common lines and additionally AR21 which is missing in MPI Field 2014 but was selected for SP1**

```{r define desired subset of lines}
lines_2014 <- sort( c(common_lines_2014, "AR21") )
length(lines_2014)
```


# Experiments 2015
## MPI FGH 2015: 72247
```{r MPI FGH 2015: 72247}
yield_data_72247 <- droplevels(subset(yield_data_no_duplicates, yield_data_no_duplicates$culture == "72247"))

dim(yield_data_72247)

# subsets for different attributes
yield_data_72247_fw <- subset(yield_data_72247,
                              yield_data_72247$value_id == "188")
yield_data_72247_sc <- subset(yield_data_72247,
                              yield_data_72247$value_id == "190")
# fw: 756
# sc: 769

table(table(yield_data_72247_sc$plant_id))
#   1   2   3 
# 749   1   6
# some entries were measured twice or thrice! 
# calculate average of those repeated measurements of starch content (sc)

# calculate mean starch content per plant
yield_data_72247_sc_mean_per_plant <- ddply(yield_data_72247_sc, "plant_id", summarise,
                                            mean = mean(as.numeric(number), na.rm = T))
pander(head(yield_data_72247_sc_mean_per_plant))
dim(yield_data_72247_sc_mean_per_plant)
# 756 --> equal to fw
```


## MPI Feld 2015: 72275
```{r MPI Feld 2015: 72275}
yield_data_72275 <- droplevels(subset(yield_data_no_duplicates, yield_data_no_duplicates$culture == "72275"))

dim(yield_data_72275)

# subsets for different attributes
yield_data_72275_fw <- subset(yield_data_72275,
                              yield_data_72275$value_id == "188")
yield_data_72275_sc <- subset(yield_data_72275,
                              yield_data_72275$value_id == "190")
yield_data_72275_sy <- subset(yield_data_72275,
                              yield_data_72275$value_id == "191")

# fw: 377
# sc: 379
# sy: 376

# find duplicates: fw
which(duplicated(yield_data_72275_fw$plant_id))
yield_data_72275_fw$plant_id[290]
pander(yield_data_72275_fw[which(yield_data_72275_fw$plant_id == "1649566"),])

idx_remove_72275_fw <- which(yield_data_no_duplicates$plant_id == "1649566" & yield_data_no_duplicates$number == 1.996)
yield_data_no_duplicates <- yield_data_no_duplicates[-idx_remove_72275_fw,]


# find duplicates: sy
which(duplicated(yield_data_72275_sc$plant_id))
yield_data_72275_sc$plant_id[c(363, 364, 379)]
pander(yield_data_72275_sc[which(yield_data_72275_sc$plant_id == "1649445"),])

idx_remove_72275_sc <- which(yield_data_no_duplicates$plant_id == "1649445" & yield_data_no_duplicates$number %in% c(170, 172, 175))
yield_data_no_duplicates <- yield_data_no_duplicates[-idx_remove_72275_sc,]
```


## JKI und Dethlingen 2015
```{r JKI und Dethlingen 2015}
yield_data_72292 <- droplevels(subset(yield_data_no_duplicates, yield_data_no_duplicates$culture == "72292"))
yield_data_72396 <- droplevels(subset(yield_data_no_duplicates, yield_data_no_duplicates$culture == "72396"))
yield_data_72482 <- droplevels(subset(yield_data_no_duplicates, yield_data_no_duplicates$culture == "72482"))

dim(yield_data_72292)
dim(yield_data_72396)
dim(yield_data_72482)
```


## Venn diagram of lines cultivated in 5 different experiments 2015
```{r venn diagram of lines cultivated in 5 different experiments 2015}

venn_2015 <- func_venn_diagram_5(res1 = yield_data_72275$alias,
                                res2 = yield_data_72247$alias,
                                res3 = yield_data_72396$alias,
                                res4 = yield_data_72292$alias,
                                res5 = yield_data_72482$alias,
                                lab1 = "MPI Field 2015",
                                lab2 = "MPI FGH 2015",
                                lab3 = "JKI Field 2015",
                                lab4 = "JKI Pot 2015",
                                lab5 = "Dethlingen 2015")

plot.new()
flog.threshold(ERROR)
grid.draw(venn_2015)
```


# Compare lines from 2014 and 2015
```{r compare lines from 2014 and 2015}
# only overlapping lines --> intersect
common_lines_2015 <- intersect(
  intersect(yield_data_72275$alias, yield_data_72247$alias),
  intersect(yield_data_72396$alias, yield_data_72292$alias))

common_lines_2015 <- sort(common_lines_2015)

length(common_lines_2015)

# all lines --> union
all_lines_2015 <- union(
  union(yield_data_72275$alias, yield_data_72247$alias),
  union(yield_data_72396$alias, yield_data_72292$alias))

all_lines_2015 <- sort(all_lines_2015)

length(all_lines_2015)
# 3 lines more than in common lines: "AR183" "EA131" "EA174" (not present in jki field and dethlingen 2015)

length(intersect(common_lines_2014, all_lines_2015))
# 62 of 63, because AR21 is missing in MPI Field 2014

setdiff(all_lines_2015, common_lines_2015)
```


# Create correct yield data table 

**Calculate Mean per plant_ID to get rid of replicated measurements**

```{r create correct yield data table}
yield_data_correct <- ddply(yield_data_no_duplicates, c("culture", "plant_id", "line_id", "alias", "name", 
                                                      "treatment", "treatment_name", "attribute", "value_id"), 
                          summarise, number = mean(as.numeric(number), na.rm = T))

pander(head(yield_data_correct))
dim(yield_data_correct)
dim(yield_data_no_duplicates)

pander(table(yield_data_correct$culture, yield_data_correct$attribute))

# subsets per year
cultures_2014 <- c(67199, 67516, 68713, 68015, 72237, 67518)
cultures_2015 <- c(72247, 72275, 72482, 72396, 72292)

# use a subset of 193 lines from either experiments of 2014 or 2015
yield_data_correct_2014 <- droplevels(subset(yield_data_correct, 
                                             yield_data_correct$culture %in% cultures_2014 & 
                                               yield_data_correct$alias %in% lines_2014))
dim(yield_data_correct_2014)
length(levels(yield_data_correct_2014$alias))

yield_data_correct_2015 <- droplevels(subset(yield_data_correct, yield_data_correct$culture %in% cultures_2015))
```


## Missing values of starch content (SC)
```{r missing values of SC}
# 2014
# which entries have NA as value --> all of them are SC values
yield_data_correct_2014_NA_idx <- which( is.na(yield_data_correct_2014$number) == TRUE) # 61 entries
# plant ID of entries with NA as SC
yield_data_correct_2014_NA_plantID <- yield_data_correct_2014$plant_id[yield_data_correct_2014_NA_idx]
# FW of entries with NA as SC 
yield_data_correct_2014_NA_FW <- subset(yield_data_correct_2014, 
                                        yield_data_correct_2014$plant_id %in% yield_data_correct_2014_NA_plantID &
                                          yield_data_correct_2014$attribute == "absolutes Frischgewicht")

# plant ID of entries with NA as SC and FW > 0.1 (9 entries)
#yield_data_correct_2014_NA_FW$plant_id [which(yield_data_correct_2014_NA_FW$number > 0.1)]

# plant ID of entries with NA as SC and FW < 0.1 --> replace NA of SC by ZERO (52 entries)
SC_NA_2014_plantID <- yield_data_correct_2014_NA_FW$plant_id [which(yield_data_correct_2014_NA_FW$number < 0.1)]

# replace NA of SC by ZERO, for plants with FW < 0.1
yield_data_correct_2014$number [which(yield_data_correct_2014$plant_id %in% SC_NA_2014_plantID
                                      & yield_data_correct_2014$attribute == "Staerkegehalt")] <- 0

length(which(is.na(yield_data_correct_2014$number)==TRUE))

##################################

# 2015
yield_data_correct_2015_NA_idx <- which( is.na(yield_data_correct_2015$number) == TRUE)
yield_data_correct_2015_NA_plantID <- yield_data_correct_2015$plant_id[yield_data_correct_2015_NA_idx]
# 1648847 1648474 --> FW of zero --> set SC to zero

yield_data_correct_2015$number [which(yield_data_correct_2015$plant_id %in% yield_data_correct_2015_NA_plantID
                                      & yield_data_correct_2015$attribute == "Staerkegehalt")] <- 0

length(which(is.na(yield_data_correct_2015$number)==TRUE))
```


# Get information about subpopulations
```{r get information about subpopulations}
# load information about SP
sp_infos <- read.table("data/valdis_subpopulations.txt", sep="\t", header=TRUE)

# this file contains duplicate entries for lines that belong to two SP
sp_infos_dup <- read.table("data/valdis_subpopulations_duplicates.txt", sep="\t", header=TRUE)

# subsets for different SP
plant_lines_sp1 <- droplevels(sp_infos$alias[which(sp_infos$SP1 == "yes")])
plant_lines_sp2 <- droplevels(sp_infos$alias[which(sp_infos$SP2 == "yes")])
plant_lines_sp3 <- droplevels(sp_infos$alias[which(sp_infos$SP3 == "yes")])
plant_lines_sp1_sp2 <- droplevels(sp_infos$alias[which(sp_infos$SP1 == "yes" & sp_infos$SP2 == "yes")])
plant_lines_sp1_sp3 <- droplevels(sp_infos$alias[which(sp_infos$SP1 == "yes" & sp_infos$SP3 == "yes")])

# order table by alias (= plant line)
sp_infos_ordered <- sp_infos[order(sp_infos$alias),]
```


## Merge SP information with yield data from 2014
```{r merge SP information with yield data from 2014}
yield_data_2014_sp <- merge(yield_data_correct_2014, sp_infos, by = "alias", all = TRUE)
dim(yield_data_2014_sp)

yield_data_2014_sp_dup <- merge(yield_data_correct_2014, sp_infos_dup, by = "alias", all = TRUE)
dim(yield_data_2014_sp_dup)
```


## Merge SP information with yield data from 2015
```{r merge SP information with yield data from 2015}
yield_data_2015_sp <- merge(yield_data_correct_2015, sp_infos, by = "alias", all = TRUE)
dim(yield_data_2015_sp)

yield_data_2015_sp_dup <- merge(yield_data_correct_2015, sp_infos_dup, by = "alias", all = TRUE)
dim(yield_data_2015_sp_dup)
```


# Subsets per attribute
```{r subsets per attribute}
# 2014
yield_data_2014_fw <- subset(yield_data_correct_2014, yield_data_correct_2014$value_id == "188")
yield_data_2014_sc <- subset(yield_data_correct_2014, yield_data_correct_2014$value_id == "190")
yield_data_2014_sy <- subset(yield_data_correct_2014, yield_data_correct_2014$value_id == "191")

# 2015
yield_data_2015_fw <- subset(yield_data_correct_2015, yield_data_correct_2015$value_id == "188")
yield_data_2015_sc <- subset(yield_data_correct_2015, yield_data_correct_2015$value_id == "190")
yield_data_2015_sy <- subset(yield_data_correct_2015, yield_data_correct_2015$value_id == "191")


# histograms of attributes
par(mfrow=c(1,2))
hist(yield_data_2014_fw$number, breaks = 20, col = "grey", main = "fresh weight 2014")
hist(yield_data_2015_fw$number, breaks = 20, col = "grey", main = "fresh weight 2015")
hist(yield_data_2014_sc$number, breaks = 20, col = "grey", main = "starch content 2014")
hist(yield_data_2015_sc$number, breaks = 20, col = "grey", main = "starch content 2015")
hist(yield_data_2014_sy$number, breaks = 20, col = "grey", main = "starch yield 2014")
hist(yield_data_2015_sy$number, breaks = 20, col = "grey", main = "starch yield 2015")
par(mfrow=c(1,1))
```


# Calculate starch yield per experiment 
**contains drymatter (%), starch content (g/kg) and starch yield (kg/plant and g/plant)**

```{r calculate starch yield}
# 2014
mpi_fgh_2014 <- func_starch_yield_feld(yield_data_2014_sp_dup, 67199, 1)
mpi_feld_2014 <- func_starch_yield_feld(yield_data_2014_sp_dup, c(67516, 68713), 5)
jki_shelter_2014 <- func_starch_yield_feld(yield_data_2014_sp_dup, c(68015, 72237), 1)
jki_feld_2014 <- func_starch_yield_feld(yield_data_2014_sp_dup, 67518, 1)

# 2015
mpi_fgh_2015 <- func_starch_yield_feld(yield_data_2015_sp_dup, 72247, 1)
mpi_feld_2015 <- func_starch_yield_feld(yield_data_2015_sp_dup, 72275, 5)
jki_shelter_2015 <- func_starch_yield_feld(yield_data_2015_sp_dup, 72292, 1)
jki_feld_2015 <- func_starch_yield_feld(yield_data_2015_sp_dup, 72396, 5)
dethlingen_2015 <- func_starch_yield_feld(yield_data_2015_sp_dup, 72482, 10)

# remove entries that have starch yield of zero
# which(mpi_feld_2014$starch_yield_g_per_plant == 0)
# which(mpi_fgh_2014$starch_yield_g_per_plant == 0)
# which(jki_shelter_2014$starch_yield_g_per_plant == 0)
# which(jki_feld_2014$starch_yield_g_per_plant == 0)
# 
# which(mpi_feld_2015$starch_yield_g_per_plant == 0)
# which(mpi_fgh_2015$starch_yield_g_per_plant == 0)
# which(jki_shelter_2015$starch_yield_g_per_plant == 0)
# which(jki_feld_2015$starch_yield_g_per_plant == 0)
# which(dethlingen_2015$starch_yield_g_per_plant == 0)

# mpi_fgh_2015 <- mpi_fgh_2015[-which(mpi_fgh_2015$starch_yield_g_per_plant == 0),]

# maybe remove entries with NAs???
which(is.na(mpi_fgh_2015$starch_yield_g_per_plant))

table(mpi_fgh_2014$treatment, mpi_fgh_2014$alias)
```


## Calculate starch yield CV
```{r calculate starch yield CV}
# 2014
mpi_fgh_2014_cv <- ddply(mpi_fgh_2014, c("alias","treatment_name"), 
                         summarise, cv = func_CV(starch_yield_g_per_plant))

mpi_feld_2014_cv <- ddply(mpi_feld_2014, c("alias","treatment_name"), 
                         summarise, cv = func_CV(starch_yield_g_per_plant))

jki_shelter_2014_cv <- ddply(jki_shelter_2014, c("alias","treatment_name"), 
                         summarise, cv = func_CV(starch_yield_g_per_plant))

jki_feld_2014_cv <- ddply(jki_feld_2014, c("alias","treatment_name"), 
                         summarise, cv = func_CV(starch_yield_g_per_plant))

# 2015
mpi_fgh_2015_cv <- ddply(mpi_fgh_2015, c("alias","treatment_name"), 
                         summarise, cv = func_CV(starch_yield_g_per_plant))

mpi_feld_2015_cv <- ddply(mpi_feld_2015, c("alias","treatment_name"), 
                         summarise, cv = func_CV(starch_yield_g_per_plant))

jki_shelter_2015_cv <- ddply(jki_shelter_2015, c("alias","treatment_name"), 
                         summarise, cv = func_CV(starch_yield_g_per_plant))

jki_feld_2015_cv <- ddply(jki_feld_2015, c("alias","treatment_name"), 
                         summarise, cv = func_CV(starch_yield_g_per_plant))

dethlingen_2015_cv <- ddply(dethlingen_2015, c("alias","treatment_name"), 
                         summarise, cv = func_CV(starch_yield_g_per_plant))
```


## Summarize replicates per line: Mean per line, treatment and experiment
```{r summarize replicates per line}
# 2014
mpi_fgh_2014_mean_per_line <- ddply(mpi_fgh_2014, c("alias", "treatment_name"), summarise,  
                                    starch_yield_g_per_plant = mean(starch_yield_g_per_plant, na.rm = T))
mpi_feld_2014_mean_per_line <- ddply(mpi_feld_2014, c("alias", "treatment_name"), summarise,  
                                    starch_yield_g_per_plant = mean(starch_yield_g_per_plant, na.rm = T))
jki_shelter_2014_mean_per_line <- ddply(jki_shelter_2014, c("alias", "treatment_name"), summarise,  
                                    starch_yield_g_per_plant = mean(starch_yield_g_per_plant, na.rm = T))
jki_feld_2014_mean_per_line <- ddply(jki_feld_2014, c("alias", "treatment_name"), summarise,  
                                    starch_yield_g_per_plant = mean(starch_yield_g_per_plant, na.rm = T))

# 2015
mpi_fgh_2015_mean_per_line <- ddply(mpi_fgh_2015, c("alias", "treatment_name"), summarise,  
                                    starch_yield_g_per_plant = mean(starch_yield_g_per_plant, na.rm = T))
mpi_feld_2015_mean_per_line <- ddply(mpi_feld_2015, c("alias", "treatment_name"), summarise,  
                                    starch_yield_g_per_plant = mean(starch_yield_g_per_plant, na.rm = T))
jki_shelter_2015_mean_per_line <- ddply(jki_shelter_2015, c("alias", "treatment_name"), summarise,  
                                    starch_yield_g_per_plant = mean(starch_yield_g_per_plant, na.rm = T))
jki_feld_2015_mean_per_line <- ddply(jki_feld_2015, c("alias", "treatment_name"), summarise,  
                                    starch_yield_g_per_plant = mean(starch_yield_g_per_plant, na.rm = T))
dethlingen_2015_mean_per_line <- ddply(dethlingen_2015, c("alias", "treatment_name"), summarise,  
                                    starch_yield_g_per_plant = mean(starch_yield_g_per_plant, na.rm = T))
```


## Subset of CONTROL starch yield
```{r subset of CONTROL starch yield}
# 2014
mpi_fgh_2014_control <- subset(mpi_fgh_2014, mpi_fgh_2014$treatment_name == "control")
mpi_feld_2014_control <- subset(mpi_feld_2014, mpi_feld_2014$treatment_name == "control")
jki_feld_2014_control <- subset(jki_feld_2014, jki_feld_2014$treatment_name == "control")
jki_shelter_2014_control <- subset(jki_shelter_2014, jki_shelter_2014$treatment_name == "control")

# 2015
mpi_fgh_2015_control <- subset(mpi_fgh_2015, mpi_fgh_2015$treatment_name == "control")
mpi_feld_2015_control <- subset(mpi_feld_2015, mpi_feld_2015$treatment_name == "control")
jki_feld_2015_control <- subset(jki_feld_2015, jki_feld_2015$treatment_name == "control")
jki_shelter_2015_control <- subset(jki_shelter_2015, jki_shelter_2015$treatment_name == "control")
dethlingen_2015_control <- subset(dethlingen_2015, dethlingen_2015$treatment_name == "control")
```


## Subset of STRESS starch yield
```{r subset of STRESS starch yield}
# 2014
mpi_fgh_2014_stress <- subset(mpi_fgh_2014, mpi_fgh_2014$treatment_name == "drought stress")
mpi_feld_2014_stress <- subset(mpi_feld_2014, mpi_feld_2014$treatment_name == "drought stress")
jki_feld_2014_stress <- subset(jki_feld_2014, jki_feld_2014$treatment_name == "drought stress")
jki_shelter_2014_stress <- subset(jki_shelter_2014, jki_shelter_2014$treatment_name == "drought stress")

# 2015
mpi_fgh_2015_stress <- subset(mpi_fgh_2015, mpi_fgh_2015$treatment_name == "drought stress")
mpi_feld_2015_stress <- subset(mpi_feld_2015, mpi_feld_2015$treatment_name == "drought stress")
jki_feld_2015_stress <- subset(jki_feld_2015, jki_feld_2015$treatment_name == "drought stress")
jki_shelter_2015_stress <- subset(jki_shelter_2015, jki_shelter_2015$treatment_name == "drought stress")
dethlingen_2015_stress <- subset(dethlingen_2015, dethlingen_2015$treatment_name == "drought stress")
```


## Calculate MEAN of starch yield per line (only control data)
```{r calculate MEAN of starch yield per line (only control data)}
# 2014
mpi_fgh_2014_control_mean_per_line <- ddply(mpi_fgh_2014_control, "alias", summarise, 
                                            mean = mean(starch_yield_g_per_plant, na.rm = T))
mpi_feld_2014_control_mean_per_line <- ddply(mpi_feld_2014_control, "alias", summarise, 
                                            mean = mean(starch_yield_g_per_plant, na.rm = T))
jki_feld_2014_control_mean_per_line <- ddply(jki_feld_2014_control, "alias", summarise, 
                                            mean = mean(starch_yield_g_per_plant, na.rm = T))
jki_shelter_2014_control_mean_per_line <- ddply(jki_shelter_2014_control, "alias", summarise, 
                                            mean = mean(starch_yield_g_per_plant, na.rm = T))
# 2015
mpi_fgh_2015_control_mean_per_line <- ddply(mpi_fgh_2015_control, "alias", summarise, 
                                            mean = mean(starch_yield_g_per_plant, na.rm = T))
mpi_feld_2015_control_mean_per_line <- ddply(mpi_feld_2015_control, "alias", summarise, 
                                            mean = mean(starch_yield_g_per_plant, na.rm = T))
jki_feld_2015_control_mean_per_line <- ddply(jki_feld_2015_control, "alias", summarise, 
                                            mean = mean(starch_yield_g_per_plant, na.rm = T))
jki_shelter_2015_control_mean_per_line <- ddply(jki_shelter_2015_control, "alias", summarise, 
                                            mean = mean(starch_yield_g_per_plant, na.rm = T))
dethlingen_2015_control_mean_per_line <- ddply(dethlingen_2015_control, "alias", summarise, 
                                            mean = mean(starch_yield_g_per_plant))

# calculate overall median of mean values per line (only control data)
# 2014
mpi_fgh_2014_control_median <- median(mpi_fgh_2014_control_mean_per_line$mean, na.rm = T) # 117.20
mpi_feld_2014_control_median <- median(mpi_feld_2014_control_mean_per_line$mean, na.rm = T) # 261.99
jki_feld_2014_control_median <- median(jki_feld_2014_control_mean_per_line$mean, na.rm = T) # 324.64
jki_shelter_2014_control_median <- median(jki_shelter_2014_control_mean_per_line$mean, na.rm = T) # 56.16

# 2015
mpi_fgh_2015_control_median <- median(mpi_fgh_2015_control_mean_per_line$mean) # 272.73
mpi_feld_2015_control_median <- median(mpi_feld_2015_control_mean_per_line$mean) # 221.56
jki_feld_2015_control_median <- median(jki_feld_2015_control_mean_per_line$mean) # 242.85
jki_shelter_2015_control_median <- median(jki_shelter_2015_control_mean_per_line$mean) # 71.91
dethlingen_2015_control_median <- median(dethlingen_2015_control_mean_per_line$mean) # 216.81
```


## Calculate MEAN of starch yield per line (only stress data)
```{r calculate MEAN of starch yield per line (only stress data)}
# 2014
mpi_fgh_2014_stress_mean_per_line <- ddply(mpi_fgh_2014_stress, "alias", summarise, 
                                            mean = mean(starch_yield_g_per_plant, na.rm = T))
mpi_feld_2014_stress_mean_per_line <- ddply(mpi_feld_2014_stress, "alias", summarise, 
                                            mean = mean(starch_yield_g_per_plant, na.rm = T))
jki_feld_2014_stress_mean_per_line <- ddply(jki_feld_2014_stress, "alias", summarise, 
                                            mean = mean(starch_yield_g_per_plant, na.rm = T))
jki_shelter_2014_stress_mean_per_line <- ddply(jki_shelter_2014_stress, "alias", summarise, 
                                            mean = mean(starch_yield_g_per_plant, na.rm = T))
# 2015
mpi_fgh_2015_stress_mean_per_line <- ddply(mpi_fgh_2015_stress, "alias", summarise, 
                                            mean = mean(starch_yield_g_per_plant, na.rm = T))
mpi_feld_2015_stress_mean_per_line <- ddply(mpi_feld_2015_stress, "alias", summarise, 
                                            mean = mean(starch_yield_g_per_plant, na.rm = T))
jki_feld_2015_stress_mean_per_line <- ddply(jki_feld_2015_stress, "alias", summarise, 
                                            mean = mean(starch_yield_g_per_plant, na.rm = T))
jki_shelter_2015_stress_mean_per_line <- ddply(jki_shelter_2015_stress, "alias", summarise, 
                                            mean = mean(starch_yield_g_per_plant, na.rm = T))
dethlingen_2015_stress_mean_per_line <- ddply(dethlingen_2015_stress, "alias", summarise, 
                                            mean = mean(starch_yield_g_per_plant))
```


## Calculate MEDIAN of starch yield per line (only control data)
```{r calculate MEDIAN of starch yield per line (only control data)}
# 2014
mpi_fgh_2014_control_median_per_line <- ddply(mpi_fgh_2014_control, "alias", summarise, 
                                            median = median(starch_yield_g_per_plant, na.rm = T))
mpi_feld_2014_control_median_per_line <- ddply(mpi_feld_2014_control, "alias", summarise, 
                                            median = median(starch_yield_g_per_plant, na.rm = T))
jki_feld_2014_control_median_per_line <- ddply(jki_feld_2014_control, "alias", summarise, 
                                            median = median(starch_yield_g_per_plant, na.rm = T))
jki_shelter_2014_control_median_per_line <- ddply(jki_shelter_2014_control, "alias", summarise, 
                                            median = median(starch_yield_g_per_plant, na.rm = T))

# 2015
mpi_fgh_2015_control_median_per_line <- ddply(mpi_fgh_2015_control, "alias", summarise, 
                                            median = median(starch_yield_g_per_plant, na.rm = T))
mpi_feld_2015_control_median_per_line <- ddply(mpi_feld_2015_control, "alias", summarise, 
                                            median = median(starch_yield_g_per_plant, na.rm = T))
jki_feld_2015_control_median_per_line <- ddply(jki_feld_2015_control, "alias", summarise, 
                                            median = median(starch_yield_g_per_plant, na.rm = T))
jki_shelter_2015_control_median_per_line <- ddply(jki_shelter_2015_control, "alias", summarise, 
                                            median = median(starch_yield_g_per_plant, na.rm = T))
dethlingen_2015_control_median_per_line <- ddply(dethlingen_2015_control, "alias", summarise, 
                                            median = median(starch_yield_g_per_plant, na.rm = T))
```


## Normalize starch yield per experiment
**use control median of each experiment to calculate ratio**
```{r normalize starch yield per experiment}
# 2014
mpi_fgh_2014$normalized_starch_yield_per_plant <- mpi_fgh_2014$starch_yield_g_per_plant / mpi_fgh_2014_control_median
mpi_feld_2014$normalized_starch_yield_per_plant <- mpi_feld_2014$starch_yield_g_per_plant / mpi_feld_2014_control_median
jki_feld_2014$normalized_starch_yield_per_plant <- jki_feld_2014$starch_yield_g_per_plant / jki_feld_2014_control_median
jki_shelter_2014$normalized_starch_yield_per_plant <- jki_shelter_2014$starch_yield_g_per_plant / jki_shelter_2014_control_median

# 2015
mpi_fgh_2015$normalized_starch_yield_per_plant <- mpi_fgh_2015$starch_yield_g_per_plant / mpi_fgh_2015_control_median
mpi_feld_2015$normalized_starch_yield_per_plant <- mpi_feld_2015$starch_yield_g_per_plant / mpi_feld_2015_control_median
jki_feld_2015$normalized_starch_yield_per_plant <- jki_feld_2015$starch_yield_g_per_plant / jki_feld_2015_control_median
jki_shelter_2015$normalized_starch_yield_per_plant <- jki_shelter_2015$starch_yield_g_per_plant / jki_shelter_2015_control_median
dethlingen_2015$normalized_starch_yield_per_plant <- dethlingen_2015$starch_yield_g_per_plant / dethlingen_2015_control_median
```


# Bind all processed yield data

**the final dataset contains:**
* tuber_FW_kg_per_plot
* starch_g_per_kg
* starch_yield_g_per_plant
* starch_yield_g_per_plot
* normalized_starch_yield_per_plant

**How to fill empty combinations:**
http://www.cookbook-r.com/Manipulating_data/Summarizing_data/#filling-empty-combinations-with-zeros-1

```{r bind all processed yield data}
yield_data_final_2014 <- rbind(mpi_fgh_2014, mpi_feld_2014, jki_feld_2014, jki_shelter_2014)
yield_data_final_2015 <- rbind(mpi_fgh_2015, mpi_feld_2015, jki_feld_2015, jki_shelter_2015, dethlingen_2015)

dim(yield_data_final_2014)
dim(yield_data_final_2015)

# 2014
yield_data_final_2014_stress <- droplevels(subset(yield_data_final_2014, yield_data_final_2014$treatment_name == "drought stress"))
yield_data_final_2014_control <- droplevels(subset(yield_data_final_2014, yield_data_final_2014$treatment_name == "control"))
dim(yield_data_final_2014_control)
dim(yield_data_final_2014_stress)

# 2015
yield_data_final_2015_stress <- droplevels(subset(yield_data_final_2015, yield_data_final_2015$treatment_name == "drought stress"))
yield_data_final_2015_control <- droplevels(subset(yield_data_final_2015, yield_data_final_2015$treatment_name == "control"))
dim(yield_data_final_2015_control)
dim(yield_data_final_2015_stress)
```


## Calculate mean of starch yield per line and experiment (all conditions)
```{r calculate mean of starch yield per line and experiment (all conditions)}
# 2014
# calculate mean of starch yield per line and experiment
yield_data_final_2014_sy_mean <- ddply(yield_data_final_2014, c("alias", "culture","treatment_name"), summarise, 
                                       sy = mean(starch_yield_g_per_plant, na.rm = T), .drop=FALSE)

pander(head(yield_data_final_2014_sy_mean))
dim(yield_data_final_2014_sy_mean)

# 2015
# calculate mean of starch yield per line and experiment
yield_data_final_2015_sy_mean <- ddply(yield_data_final_2015, c("alias", "culture","treatment_name"), summarise, 
                                      sy = mean(starch_yield_g_per_plant, na.rm = T), .drop=FALSE)

pander(head(yield_data_final_2015_sy_mean))
dim(yield_data_final_2015_sy_mean)
```


## Calculate mean of starch yield per line and experiment (only control)
```{r calculate mean of starch yield per line and experiment (only control)}
# 2014
# calculate mean of starch yield per line and experiment
yield_data_final_2014_control_sy_mean <- ddply(yield_data_final_2014_control, c("alias", "culture"), summarise, 
                                            sy = mean(starch_yield_g_per_plant, na.rm = T), .drop=FALSE)

pander(head(yield_data_final_2014_control_sy_mean))
dim(yield_data_final_2014_control_sy_mean)

# 2015
# calculate mean of starch yield per line and experiment
yield_data_final_2015_control_sy_mean <- ddply(yield_data_final_2015_control, c("alias", "culture"), summarise, 
                                            sy = mean(starch_yield_g_per_plant, na.rm = T), .drop=FALSE)

pander(head(yield_data_final_2015_control_sy_mean))
dim(yield_data_final_2015_control_sy_mean)
```


## Calculate mean of starch yield per line and experiment (only stress)
```{r calculate mean of starch yield per line and experiment (only stress)}
# 2014
# calculate mean of starch yield per line and experiment
yield_data_final_2014_stress_sy_mean <- ddply(yield_data_final_2014_stress, c("alias", "culture"), summarise, 
                                            sy = mean(starch_yield_g_per_plant, na.rm = T), .drop=FALSE)

pander(head(yield_data_final_2014_stress_sy_mean))
dim(yield_data_final_2014_stress_sy_mean)

# 2015
# calculate mean of starch yield per line and experiment
yield_data_final_2015_stress_sy_mean <- ddply(yield_data_final_2015_stress, c("alias", "culture"), summarise, 
                                            sy = mean(starch_yield_g_per_plant, na.rm = T), .drop=FALSE)

pander(head(yield_data_final_2015_stress_sy_mean))
dim(yield_data_final_2015_stress_sy_mean)
```


## Calculate mean of NORMALIZED starch yield per line and experiment
```{r calculate mean of NORMALIZED starch yield per line and experiment}
# 2014
yield_data_final_2014_control_norm_sy_mean <- ddply(yield_data_final_2014_control, c("alias", "culture"), summarise, 
                                               norm_sy = mean(normalized_starch_yield_per_plant, na.rm = T), .drop=FALSE)

pander(head(yield_data_final_2014_control_norm_sy_mean))
dim(yield_data_final_2014_control_norm_sy_mean)

# 2015
yield_data_final_2015_control_norm_sy_mean <- ddply(yield_data_final_2015_control, c("alias", "culture"), summarise, 
                                               norm_sy = mean(normalized_starch_yield_per_plant, na.rm = T), .drop=FALSE)

pander(head(yield_data_final_2015_control_norm_sy_mean))
dim(yield_data_final_2015_control_norm_sy_mean)
```


# Subsets for subpopulations
## Subsets for subpopulations 2014
```{r subsets for subpopulations 2014}
# all data
yield_data_final_2014_sp1 <- subset(yield_data_final_2014, yield_data_final_2014$SP == "SP1")
yield_data_final_2014_sp2 <- subset(yield_data_final_2014, yield_data_final_2014$SP == "SP2")
yield_data_final_2014_sp3 <- subset(yield_data_final_2014, yield_data_final_2014$SP == "SP3")

# treatment: control
yield_data_final_2014_control_sp1 <- subset(yield_data_final_2014_control, yield_data_final_2014_control$SP == "SP1")
yield_data_final_2014_control_sp2 <- subset(yield_data_final_2014_control, yield_data_final_2014_control$SP == "SP2")
yield_data_final_2014_control_sp3 <- subset(yield_data_final_2014_control, yield_data_final_2014_control$SP == "SP2")

## SP1 vs. SP2
t.test(yield_data_final_2014_control_sp1$normalized_starch_yield_per_plant, 
       yield_data_final_2014_control_sp2$normalized_starch_yield_per_plant)
## SP2 vs. SP3
t.test(yield_data_final_2014_control_sp2$normalized_starch_yield_per_plant, 
       yield_data_final_2014_control_sp3$normalized_starch_yield_per_plant)
## SP1 vs. SP3
t.test(yield_data_final_2014_control_sp1$normalized_starch_yield_per_plant, 
       yield_data_final_2014_control_sp3$normalized_starch_yield_per_plant)

# treatment: drought stress
yield_data_final_2014_stress_sp1 <- subset(yield_data_final_2014_stress, yield_data_final_2014_stress$SP == "SP1")
yield_data_final_2014_stress_sp2 <- subset(yield_data_final_2014_stress, yield_data_final_2014_stress$SP == "SP2")
yield_data_final_2014_stress_sp3 <- subset(yield_data_final_2014_stress, yield_data_final_2014_stress$SP == "SP3")

## SP1 vs. SP2
t.test(yield_data_final_2014_stress_sp1$normalized_starch_yield_per_plant, 
       yield_data_final_2014_stress_sp2$normalized_starch_yield_per_plant)
```


## Subsets for subpopulations 2015
```{r subsets for subpopulations 2015}
# all data
yield_data_final_2015_sp1 <- subset(yield_data_final_2015, yield_data_final_2015$SP == "SP1")
yield_data_final_2015_sp2 <- subset(yield_data_final_2015, yield_data_final_2015$SP == "SP2")
yield_data_final_2015_sp3 <- subset(yield_data_final_2015, yield_data_final_2015$SP == "SP3")

# treatment: control
yield_data_final_2015_control_sp1 <- subset(yield_data_final_2015_control, yield_data_final_2015_control$SP == "SP1")
yield_data_final_2015_control_sp2 <- subset(yield_data_final_2015_control, yield_data_final_2015_control$SP == "SP2")
yield_data_final_2015_control_sp3 <- subset(yield_data_final_2015_control, yield_data_final_2015_control$SP == "SP2")

## SP1 vs. SP2
t.test(yield_data_final_2015_control_sp1$normalized_starch_yield_per_plant, 
       yield_data_final_2015_control_sp2$normalized_starch_yield_per_plant)
## SP2 vs. SP3
t.test(yield_data_final_2015_control_sp2$normalized_starch_yield_per_plant, 
       yield_data_final_2015_control_sp3$normalized_starch_yield_per_plant)


# treatment: drought stress
yield_data_final_2015_stress_sp1 <- subset(yield_data_final_2015_stress, yield_data_final_2015_stress$SP == "SP1")
yield_data_final_2015_stress_sp2 <- subset(yield_data_final_2015_stress, yield_data_final_2015_stress$SP == "SP2")
yield_data_final_2015_stress_sp3 <- subset(yield_data_final_2015_stress, yield_data_final_2015_stress$SP == "SP3")

## SP1 vs. SP2
t.test(yield_data_final_2015_stress_sp1$normalized_starch_yield_per_plant, 
       yield_data_final_2015_stress_sp2$normalized_starch_yield_per_plant)
```


# Explorative plots
## Explorative plots - absolute starch yield - treatment 2014
```{r explorative plots - absolute starch yield - treatment 2014}
# absolute starch yield
pdf("figures/valdis_boxplot_starch_yield_treatment_2014.pdf")
boxplot(mpi_fgh_2014$starch_yield_g_per_plant ~ mpi_fgh_2014$treatment_name, 
        col = cols_treatment, main = "MPI foil greenhouse 2014")

boxplot(mpi_feld_2014$starch_yield_g_per_plant ~ mpi_feld_2014$treatment_name, 
        col = cols_treatment, main = "MPI field 2014")

boxplot(jki_shelter_2014$starch_yield_g_per_plant ~ jki_shelter_2014$treatment_name, 
        col = cols_treatment, main = "JKI shelter 2014")

boxplot(jki_feld_2014$starch_yield_g_per_plant ~ jki_feld_2014$treatment_name, 
        col = cols_treatment, main = "JKI field 2014")
dev.off()


# treatment * culture
range(yield_data_final_2014$starch_yield_g_per_plant, na.rm = T)
ylim_values <- c(0, 800)

pdf("figures/valdis_boxplot_starch_yield_treatment_culture_2014.pdf", width = 8, height = 6)

boxplot(yield_data_final_2014$starch_yield_g_per_plant ~ yield_data_final_2014$treatment_name * yield_data_final_2014$culture, 
        col = cols_treatment, main = "SY all experiments 2014", ylim = ylim_values, ylab = "Stärkeertrag in g/Pflanze")
legend("topright", legend=c("Kontrolle", "Trockenstress"), fill=cols_treatment)

dev.off()
```


## Explorative plots - absolute starch yield - treatment 2015
```{r explorative plots - absolute starch yield - treatment 2015}
# absolute starch yield
pdf("figures/valdis_boxplot_starch_yield_treatment_2015.pdf")
boxplot(mpi_fgh_2015$starch_yield_g_per_plant ~ mpi_fgh_2015$treatment_name, 
        col = cols_treatment, main = "MPI foil greenhouse 2015")

boxplot(mpi_feld_2015$starch_yield_g_per_plant ~ mpi_feld_2015$treatment_name, 
        col = cols_treatment, main = "MPI field 2015")

boxplot(jki_shelter_2015$starch_yield_g_per_plant ~ jki_shelter_2015$treatment_name, 
        col = cols_treatment, main = "JKI shelter 2015")

boxplot(jki_feld_2015$starch_yield_g_per_plant ~ jki_feld_2015$treatment_name, 
        col = cols_treatment, main = "JKI field 2015")

boxplot(dethlingen_2015$starch_yield_g_per_plant ~ dethlingen_2015$treatment_name, 
        col = cols_treatment, main = "Dethlingen 2015")
dev.off()


# treatment * culture
range(yield_data_final_2015$starch_yield_g_per_plant, na.rm = T)
ylim_values <- c(0, 500)

pdf("figures/valdis_boxplot_starch_yield_treatment_culture_2015.pdf", width = 8, height = 6)

boxplot(yield_data_final_2015$starch_yield_g_per_plant ~ yield_data_final_2015$treatment_name * yield_data_final_2015$culture, 
        col = cols_treatment, main = "SY all experiments 2015", ylim = ylim_values, ylab = "Stärkeertrag in g/Pflanze")
legend("topright", legend=c("Kontrolle", "Trockenstress"), fill=cols_treatment)

dev.off()
```


## Explorative plots - normalized starch yield - treatment 2014
```{r explorative plots - normalized starch yield - treatment 2014}
ylim_values <- c(0,2)

pdf("figures/valdis_boxplot_starch_yield_norm_treatment_2014.pdf")

boxplot(yield_data_final_2014$normalized_starch_yield_per_plant ~ yield_data_final_2014$treatment_name, 
        col = cols_treatment, main = "all experiments 2014", ylim = ylim_values)

boxplot(mpi_fgh_2014$normalized_starch_yield_per_plant ~ mpi_fgh_2014$treatment_name, 
        col = cols_treatment, main = "MPI foil greenhouse 2014", ylim = ylim_values)

boxplot(mpi_feld_2014$normalized_starch_yield_per_plant ~ mpi_feld_2014$treatment_name, 
        col = cols_treatment, main = "MPI field 2014", ylim = ylim_values)

boxplot(jki_shelter_2014$normalized_starch_yield_per_plant ~ jki_shelter_2014$treatment_name, 
        col = cols_treatment, main = "JKI shelter 2014", ylim = ylim_values)

boxplot(jki_feld_2014$normalized_starch_yield_per_plant ~ jki_feld_2014$treatment_name, 
        col = cols_treatment, main = "JKI field 2014", ylim = ylim_values)

dev.off()


# treatment * culture
ylim_values <- c(0, 2.2)

pdf("figures/valdis_boxplot_starch_yield_norm_treatment_culture_2014.pdf", width = 8, height = 6)

boxplot(yield_data_final_2014$normalized_starch_yield_per_plant ~ yield_data_final_2014$treatment_name * yield_data_final_2014$culture, 
        col = cols_treatment, main = "normalized SY all experiments 2014", ylim = ylim_values, ylab = "normalisierter Stärkeertrag")
legend("topright", legend=c("Kontrolle", "Trockenstress"), fill=cols_treatment)

dev.off()


# mean of norm SY per culture and treatment
pander(ddply(yield_data_final_2014, c("culture", "treatment"), summarise, 
             mean = mean(normalized_starch_yield_per_plant)))
# median
pander(ddply(yield_data_final_2014, c("culture", "treatment"), summarise, 
             median = median(normalized_starch_yield_per_plant)))
```


## Explorative plots - normalized starch yield - treatment 2015
```{r explorative plots - normalized starch yield - treatment 2015}
ylim_values <- c(0,2)

pdf("figures/valdis_boxplot_starch_yield_norm_treatment_2015.pdf")

boxplot(yield_data_final_2015$normalized_starch_yield_per_plant ~ yield_data_final_2015$treatment_name, 
        col = cols_treatment, main = "all experiments 2015", ylim = ylim_values)

boxplot(mpi_fgh_2015$normalized_starch_yield_per_plant ~ mpi_fgh_2015$treatment_name, 
        col = cols_treatment, main = "MPI foil greenhouse 2015", ylim = ylim_values)

boxplot(mpi_feld_2015$normalized_starch_yield_per_plant ~ mpi_feld_2015$treatment_name, 
        col = cols_treatment, main = "MPI field 2015", ylim = ylim_values)

boxplot(jki_shelter_2015$normalized_starch_yield_per_plant ~ jki_shelter_2015$treatment_name, 
        col = cols_treatment, main = "JKI shelter 2015", ylim = ylim_values)

boxplot(jki_feld_2015$normalized_starch_yield_per_plant ~ jki_feld_2015$treatment_name, 
        col = cols_treatment, main = "JKI field 2015", ylim = ylim_values)

boxplot(dethlingen_2015$normalized_starch_yield_per_plant ~ dethlingen_2015$treatment_name, 
        col = cols_treatment, main = "Dethlingen 2015", ylim = ylim_values)
dev.off()


# treatment * culture
ylim_values <- c(0, 2.2)

pdf("figures/valdis_boxplot_starch_yield_norm_treatment_culture_2015.pdf", width = 8, height = 6)

boxplot(yield_data_final_2015$normalized_starch_yield_per_plant ~ yield_data_final_2015$treatment_name * yield_data_final_2015$culture, 
        col = cols_treatment, main = "normalized SY all experiments 2015", ylim = ylim_values, ylab = "normalisierter Stärkeertrag")
legend("topright", legend=c("Kontrolle", "Trockenstress"), fill=cols_treatment)

dev.off()


# mean of norm SY per culture and treatment
pander(ddply(yield_data_final_2015, c("culture", "treatment"), summarise, 
             mean = mean(normalized_starch_yield_per_plant)))
# median
pander(ddply(yield_data_final_2015, c("culture", "treatment"), summarise, 
             median = median(normalized_starch_yield_per_plant)))
```


## Explorative plots - absolute starch yield - treatment * plant line 2014
```{r explorative plots - absolute starch yield - treatment * plant line 2014}
pdf("figures/valdis_boxplot_starch_yield_treatment_line_2014.pdf", width=20, height=8)
par(mar=c(8,4,4,2))

boxplot(mpi_fgh_2014$starch_yield_g_per_plant ~ mpi_fgh_2014$treatment_name * mpi_fgh_2014$alias, 
        col = cols_treatment, las = 2, cex.axis = 0.8, main = "MPI foil greenhouse 2014")

boxplot(mpi_feld_2014$starch_yield_g_per_plant ~ mpi_feld_2014$treatment_name * mpi_feld_2014$alias, 
        col = cols_treatment, las = 2, cex.axis = 0.8, main = "MPI field 2014")

boxplot(jki_shelter_2014$starch_yield_g_per_plant ~ jki_shelter_2014$treatment_name * jki_shelter_2014$alias, 
        col = cols_treatment, las = 2, cex.axis = 0.8, main = "JKI shelter 2014")

boxplot(jki_feld_2014$starch_yield_g_per_plant ~ jki_feld_2014$treatment_name * jki_feld_2014$alias, 
        col = cols_treatment, las = 2, cex.axis = 0.8, main = "JKI field 2014")
dev.off()
```


## Explorative plots - absolute starch yield - treatment * plant line 2015
```{r explorative plots - absolute starch yield - treatment * plant line 2015}
pdf("figures/valdis_boxplot_starch_yield_treatment_line_2015.pdf", width=16, height=8)
par(mar=c(8,4,4,2))

boxplot(mpi_fgh_2015$starch_yield_g_per_plant ~ mpi_fgh_2015$treatment_name * mpi_fgh_2015$alias, 
        col = cols_treatment, las = 2, cex.axis = 0.8, main = "MPI foil greenhouse 2015")

boxplot(mpi_feld_2015$starch_yield_g_per_plant ~ mpi_feld_2015$treatment_name * mpi_feld_2015$alias, 
        col = cols_treatment, las = 2, cex.axis = 0.8, main = "MPI field 2015")

boxplot(jki_shelter_2015$starch_yield_g_per_plant ~ jki_shelter_2015$treatment_name * jki_shelter_2015$alias, 
        col = cols_treatment, las = 2, cex.axis = 0.8, main = "JKI shelter 2015")

boxplot(jki_feld_2015$starch_yield_g_per_plant ~ jki_feld_2015$treatment_name * jki_feld_2015$alias, 
        col = cols_treatment, las = 2, cex.axis = 0.8, main = "JKI field 2015")

boxplot(dethlingen_2015$starch_yield_g_per_plant ~ dethlingen_2015$treatment_name * dethlingen_2015$alias, 
        col = cols_treatment, las = 2, cex.axis = 0.8, main = "Dethlingen 2015")
dev.off()
```


## func_boxplot_ordered_by_median
```{r func_boxplot_ordered_by_median}
# SY ordered by control median
func_boxplot_ordered_by_median <- function(control_data = mpi_fgh_2015_control, 
                                           all_data = mpi_fgh_2015,
                                           parameter = "starch_yield_g_per_plant",
                                           main_string = "MPI foil greenhouse 2015"){
  
  median_per_line <- aggregate(control_data[,parameter], 
                               by = list(control_data$alias), median, na.rm = T)
  
  line_order <- order(median_per_line$x, decreasing = T)
  
  ordered_levels <- levels(control_data$alias)[line_order]
  
  all_data$alias_ordered <- factor(all_data$alias, levels=ordered_levels)
  
  boxplot(all_data[,parameter] ~ all_data$treatment_name * all_data$alias_ordered, 
          col = cols_treatment, las = 2, cex.axis = 0.8, main = main_string)
  
}
```


## Explorative plots - absolute starch yield - treatment * plant line ordered 2014
```{r explorative plots - absolute starch yield - treatment * plant line ordered 2014}
pdf("figures/valdis_boxplot_starch_yield_treatment_line_ordered_2014.pdf", width=20, height=8)
par(mar=c(8,4,4,2))

func_boxplot_ordered_by_median(control_data = mpi_fgh_2014_control,
                               all_data = mpi_fgh_2014,
                               main_string = "MPI FGH 2014")

func_boxplot_ordered_by_median(control_data = mpi_feld_2014_control,
                               all_data = mpi_feld_2014,
                               main_string = "MPI field 2014")

func_boxplot_ordered_by_median(control_data = jki_feld_2014_control,
                               all_data = jki_feld_2014,
                               main_string = "JKI field 2014")

func_boxplot_ordered_by_median(control_data = jki_shelter_2014_control,
                               all_data = jki_shelter_2014,
                               main_string = "JKI shelter 2014")
dev.off()
```

## Explorative plots - absolute starch yield - treatment * plant line ordered 2015
```{r explorative plots - absolute starch yield - treatment * plant line ordered 2015}
pdf("figures/valdis_boxplot_starch_yield_treatment_line_ordered_2015.pdf", width=16, height=8)
par(mar=c(8,4,4,2))

func_boxplot_ordered_by_median() # default: MPI FGH 2015

func_boxplot_ordered_by_median(control_data = mpi_feld_2015_control,
                               all_data = mpi_feld_2015,
                               main_string = "MPI field 2015")

func_boxplot_ordered_by_median(control_data = jki_feld_2015_control,
                               all_data = jki_feld_2015,
                               main_string = "JKI field 2015")

func_boxplot_ordered_by_median(control_data = jki_shelter_2015_control,
                               all_data = jki_shelter_2015,
                               main_string = "JKI shelter 2015")

func_boxplot_ordered_by_median(control_data = dethlingen_2015_control,
                               all_data = dethlingen_2015,
                               main_string = "Dethlingen 2015")
dev.off()
```


## Explorative plots - normalized starch yield - treatment * plant line 2014
```{r explorative plots - normalized starch yield - treatment * plant line 2014}
range(yield_data_final_2014$normalized_starch_yield_per_plant, na.rm = T)
ylim_values <- c(0, 2.7)
pdf("figures/valdis_boxplot_starch_yield_norm_treatment_line_2014.pdf", width=16, height=8)
par(mar=c(8,4,4,2))
boxplot(yield_data_final_2014$normalized_starch_yield_per_plant ~ yield_data_final_2014$treatment_name * yield_data_final_2014$alias, 
        col = cols_treatment, las = 2, cex.axis = 0.8, main = "all experiments 2014", ylim = ylim_values)

boxplot(mpi_fgh_2014$normalized_starch_yield_per_plant ~ mpi_fgh_2014$treatment_name * mpi_fgh_2014$alias, 
        col = cols_treatment, las = 2, cex.axis = 0.8, main = "MPI foil greenhouse 2014", ylim = ylim_values)
boxplot(mpi_feld_2014$normalized_starch_yield_per_plant ~ mpi_feld_2014$treatment_name * mpi_feld_2014$alias, 
        col = cols_treatment, las = 2, cex.axis = 0.8, main = "MPI field 2014", ylim = ylim_values)
boxplot(jki_shelter_2014$normalized_starch_yield_per_plant ~ jki_shelter_2014$treatment_name * jki_shelter_2014$alias, 
        col = cols_treatment, las = 2, cex.axis = 0.8, main = "JKI shelter 2014", ylim = ylim_values)
boxplot(jki_feld_2014$normalized_starch_yield_per_plant ~ jki_feld_2014$treatment_name * jki_feld_2014$alias, 
        col = cols_treatment, las = 2, cex.axis = 0.8, main = "JKI field 2014", ylim = ylim_values)
dev.off()
```


## Explorative plots - normalized starch yield - treatment * plant line 2015
```{r explorative plots - normalized starch yield - treatment * plant line 2015}
ylim_values <- c(0, 1.85)
pdf("figures/valdis_boxplot_starch_yield_norm_treatment_line_2015.pdf", width=16, height=8)
par(mar=c(8,4,4,2))
boxplot(yield_data_final_2015$normalized_starch_yield_per_plant ~ yield_data_final_2015$treatment_name * yield_data_final_2015$alias, 
        col = cols_treatment, las = 2, cex.axis = 0.8, main = "all experiments 2015", ylim = ylim_values)

boxplot(mpi_fgh_2015$normalized_starch_yield_per_plant ~ mpi_fgh_2015$treatment_name * mpi_fgh_2015$alias, 
        col = cols_treatment, las = 2, cex.axis = 0.8, main = "MPI foil greenhouse 2015", ylim = ylim_values)
boxplot(mpi_feld_2015$normalized_starch_yield_per_plant ~ mpi_feld_2015$treatment_name * mpi_feld_2015$alias, 
        col = cols_treatment, las = 2, cex.axis = 0.8, main = "MPI field 2015", ylim = ylim_values)
boxplot(jki_shelter_2015$normalized_starch_yield_per_plant ~ jki_shelter_2015$treatment_name * jki_shelter_2015$alias, 
        col = cols_treatment, las = 2, cex.axis = 0.8, main = "JKI shelter 2015", ylim = ylim_values)
boxplot(jki_feld_2015$normalized_starch_yield_per_plant ~ jki_feld_2015$treatment_name * jki_feld_2015$alias, 
        col = cols_treatment, las = 2, cex.axis = 0.8, main = "JKI field 2015", ylim = ylim_values)
boxplot(dethlingen_2015$normalized_starch_yield_per_plant ~ dethlingen_2015$treatment_name * dethlingen_2015$alias, 
        col = cols_treatment, las = 2, cex.axis = 0.8, main = "Dethlingen 2015", ylim = ylim_values)
dev.off()
```


## Explorative plots - normalized starch yield - treatment * plant line ordered
```{r explorative plots - normalized starch yield - treatment * plant line ordered}
# normalized SY ordered by control median
# 2014
pdf("figures/valdis_boxplot_starch_yield_norm_treatment_line_ordered_2014.pdf", width=20, height=8)
par(mar=c(8,4,4,2))

func_boxplot_ordered_by_median(control_data = yield_data_final_2014_control, 
                               all_data = yield_data_final_2014,
                               parameter = "normalized_starch_yield_per_plant",
                               main_string = "all experiments")

dev.off()

# 2015
pdf("figures/valdis_boxplot_starch_yield_norm_treatment_line_ordered_2015.pdf", width=16, height=8)
par(mar=c(8,4,4,2))

func_boxplot_ordered_by_median(control_data = yield_data_final_2015_control, 
                               all_data = yield_data_final_2015,
                               parameter = "normalized_starch_yield_per_plant",
                               main_string = "all experiments")

dev.off()
```


## Explorative plots - absolute starch yield - treatment * SP
```{r explorative plots - absolute starch yield - treatment * SP}

boxplot_names <- levels(interaction(yield_data_2015_sp_dup$treatment_name, yield_data_2015_sp_dup$SP))
boxplot_names <- gsub("\\.", "\n", boxplot_names)

pdf("figures/valdis_boxplot_starch_yield_treatment_sp_2015.pdf", width=8, height=6)

boxplot(yield_data_final_2015$starch_yield_g_per_plant ~ yield_data_final_2015$treatment_name * yield_data_final_2015$SP, 
        col = cols_sp_treatment, main = "all experiments 2015", ylim = c(0,470), names = boxplot_names, cex.axis = 0.8)

boxplot(mpi_fgh_2015$starch_yield_g_per_plant ~ mpi_fgh_2015$treatment_name * mpi_fgh_2015$SP, 
        col = cols_sp_treatment, main = "MPI FGH 2015", ylim = c(0,470), names = boxplot_names, cex.axis = 0.8)

boxplot(mpi_feld_2015$starch_yield_g_per_plant ~ mpi_feld_2015$treatment_name * mpi_feld_2015$SP, 
        col = cols_sp_treatment, main = "MPI Feld 2015", ylim = c(0,400), names = boxplot_names, cex.axis = 0.8)

boxplot(jki_feld_2015$starch_yield_g_per_plant ~ jki_feld_2015$treatment_name * jki_feld_2015$SP, 
        col = cols_sp_treatment, main = "JKI Feld 2015", ylim = c(0,400), names = boxplot_names, cex.axis = 0.8)

boxplot(jki_shelter_2015$starch_yield_g_per_plant ~ jki_shelter_2015$treatment_name * jki_shelter_2015$SP, 
        col = cols_sp_treatment, main = "JKI Shelter 2015", ylim = c(0,100), names = boxplot_names, cex.axis = 0.8)

boxplot(dethlingen_2015$starch_yield_g_per_plant ~ dethlingen_2015$treatment_name * dethlingen_2015$SP, 
        col = cols_sp_treatment, main = "Dehtlingen 2015", ylim = c(0,400), names = boxplot_names, cex.axis = 0.8)
dev.off()
```


## Explorative plots - normalized starch yield - treatment * SP 2014
```{r explorative plots - normalized starch yield - treatment * SP 2014}
ylim_values <- c(0,2.8)

pdf("figures/valdis_boxplot_starch_yield_norm_treatment_sp_2014.pdf", width=8, height=6)

boxplot(yield_data_final_2014$normalized_starch_yield_per_plant ~ yield_data_final_2014$treatment_name * yield_data_final_2014$SP, 
        col = cols_sp_treatment, main = "all experiments 2014", ylim = ylim_values, names = boxplot_names, 
        cex.axis = 0.8, ylab = "normalisierter Stärkeertrag")

boxplot(mpi_fgh_2014$normalized_starch_yield_per_plant ~ mpi_fgh_2014$treatment_name * mpi_fgh_2014$SP, 
        col = cols_sp_treatment, main = "MPI FGH 2014", ylim = ylim_values, names = boxplot_names, 
        cex.axis = 0.8, ylab = "normalisierter Stärkeertrag")

boxplot(mpi_feld_2014$normalized_starch_yield_per_plant ~ mpi_feld_2014$treatment_name * mpi_feld_2014$SP, 
        col = cols_sp_treatment, main = "MPI Feld 2014", ylim = ylim_values, names = boxplot_names, 
        cex.axis = 0.8, ylab = "normalisierter Stärkeertrag")

boxplot(jki_feld_2014$normalized_starch_yield_per_plant ~ jki_feld_2014$treatment_name * jki_feld_2014$SP, 
        col = cols_sp_treatment, main = "JKI Feld 2014", ylim = ylim_values, names = boxplot_names, 
        cex.axis = 0.8, ylab = "normalisierter Stärkeertrag")

boxplot(jki_shelter_2014$normalized_starch_yield_per_plant ~ jki_shelter_2014$treatment_name * jki_shelter_2014$SP, 
        col = cols_sp_treatment, main = "JKI Shelter 2014", ylim = ylim_values, names = boxplot_names, 
        cex.axis = 0.8, ylab = "normalisierter Stärkeertrag")
dev.off()
```


## Explorative plots - normalized starch yield - treatment * SP 2015
```{r explorative plots - normalized starch yield - treatment * SP 2015}
ylim_values <- c(0,1.85)

pdf("figures/valdis_boxplot_starch_yield_norm_treatment_sp_2015.pdf", width=8, height=6)

boxplot(yield_data_final_2015$normalized_starch_yield_per_plant ~ yield_data_final_2015$treatment_name * yield_data_final_2015$SP, 
        col = cols_sp_treatment, main = "all experiments 2015", ylim = ylim_values, names = boxplot_names, 
        cex.axis = 0.8, ylab = "normalisierter Stärkeertrag")

boxplot(mpi_fgh_2015$normalized_starch_yield_per_plant ~ mpi_fgh_2015$treatment_name * mpi_fgh_2015$SP, 
        col = cols_sp_treatment, main = "MPI FGH 2015", ylim = ylim_values, names = boxplot_names, 
        cex.axis = 0.8, ylab = "normalisierter Stärkeertrag")

boxplot(mpi_feld_2015$normalized_starch_yield_per_plant ~ mpi_feld_2015$treatment_name * mpi_feld_2015$SP, 
        col = cols_sp_treatment, main = "MPI Feld 2015", ylim = ylim_values, names = boxplot_names, 
        cex.axis = 0.8, ylab = "normalisierter Stärkeertrag")

boxplot(jki_feld_2015$normalized_starch_yield_per_plant ~ jki_feld_2015$treatment_name * jki_feld_2015$SP, 
        col = cols_sp_treatment, main = "JKI Feld 2015", ylim = ylim_values, names = boxplot_names, 
        cex.axis = 0.8, ylab = "normalisierter Stärkeertrag")

boxplot(jki_shelter_2015$normalized_starch_yield_per_plant ~ jki_shelter_2015$treatment_name * jki_shelter_2015$SP, 
        col = cols_sp_treatment, main = "JKI Shelter 2015", ylim = ylim_values, names = boxplot_names, 
        cex.axis = 0.8, ylab = "normalisierter Stärkeertrag")

boxplot(dethlingen_2015$normalized_starch_yield_per_plant ~ dethlingen_2015$treatment_name * dethlingen_2015$SP, 
        col = cols_sp_treatment, main = "Dehtlingen 2015", ylim = ylim_values, names = boxplot_names, 
        cex.axis = 0.8, ylab = "normalisierter Stärkeertrag")
dev.off()
```


## ANOVA for starch yield
```{r ANOVA for starch yield}
# 2014
mpi_fgh_2014_anova <- func_anova_2fac_ia(mpi_fgh_2014, "starch_yield_g_per_plant", "alias", "treatment", 0.05)
mpi_feld_2014_anova <- func_anova_2fac_ia(mpi_feld_2014, "starch_yield_g_per_plant", "alias", "treatment", 0.05)
jki_feld_2014_anova <- func_anova_2fac_ia(jki_feld_2014, "starch_yield_g_per_plant", "alias", "treatment", 0.05)
jki_shelter_2014_anova <- func_anova_2fac_ia(jki_shelter_2014, "starch_yield_g_per_plant", "alias", "treatment", 0.05)

# 2015
mpi_fgh_2015_anova <- func_anova_2fac_ia(mpi_fgh_2015, "starch_yield_g_per_plant", "alias", "treatment", 0.05)
mpi_feld_2015_anova <- func_anova_2fac_ia(mpi_feld_2015, "starch_yield_g_per_plant", "alias", "treatment", 0.05)
jki_feld_2015_anova <- func_anova_2fac_ia(jki_feld_2015, "starch_yield_g_per_plant", "alias", "treatment", 0.05)
jki_shelter_2015_anova <- func_anova_2fac_ia(jki_shelter_2015, "starch_yield_g_per_plant", "alias", "treatment", 0.05)
dethlingen_2015_anova <- func_anova_2fac_ia(dethlingen_2015, "starch_yield_g_per_plant", "alias", "treatment", 0.05)
```


# Calculate stress index (SI)
**Stress index is 1 - (mean(SY_drought) / mean(SY_control))**
```{r calculate stress index (SI)}
# 2014
dflist_2014 <- list(mpi_feld_2014, mpi_fgh_2014, jki_shelter_2014, jki_feld_2014)

all_SI_list_2014 <- lapply(dflist_2014, func_calc_stress_index_valdis)
all_SI_2014 <- unlist(all_SI_list_2014)

mpi_fgh_2014_si <- func_calc_stress_index_valdis(mpi_fgh_2014)
mpi_feld_2014_si <- func_calc_stress_index_valdis(mpi_feld_2014)
jki_shelter_2014_si <- func_calc_stress_index_valdis(jki_shelter_2014)
jki_feld_2014_si <- func_calc_stress_index_valdis(jki_feld_2014)


# 2015
dflist_2015 <- list(mpi_feld_2015, mpi_fgh_2015, jki_shelter_2015,
               jki_feld_2015, dethlingen_2015)

all_SI_list_2015 <- lapply(dflist_2015, func_calc_stress_index_valdis)
all_SI_2015 <- unlist(all_SI_list_2015)

mpi_fgh_2015_si <- func_calc_stress_index_valdis(mpi_fgh_2015)
mpi_feld_2015_si <- func_calc_stress_index_valdis(mpi_feld_2015)
jki_shelter_2015_si <- func_calc_stress_index_valdis(jki_shelter_2015)
jki_feld_2015_si <- func_calc_stress_index_valdis(jki_feld_2015)
dethlingen_2015_si <- func_calc_stress_index_valdis(dethlingen_2015)
```


# Calculate Relative Starch Yield (RelSY)
```{r calculate RelSY}
# 2014
mpi_fgh_2014_relSY <- func_calc_relSY_valdis(mpi_fgh_2014, plant_lines = lines_2014)
mpi_feld_2014_relSY <- func_calc_relSY_valdis(mpi_feld_2014, plant_lines = lines_2014)
jki_feld_2014_relSY <- func_calc_relSY_valdis(jki_feld_2014, plant_lines = lines_2014)
jki_shelter_2014_relSY <- func_calc_relSY_valdis(jki_shelter_2014, plant_lines = lines_2014)

# 2015
mpi_fgh_2015_relSY <- func_calc_relSY_valdis(mpi_fgh_2015, plant_lines = all_lines_2015)
mpi_feld_2015_relSY <- func_calc_relSY_valdis(mpi_feld_2015, plant_lines = all_lines_2015)
jki_feld_2015_relSY <- func_calc_relSY_valdis(jki_feld_2015, plant_lines = all_lines_2015)
jki_shelter_2015_relSY <- func_calc_relSY_valdis(jki_shelter_2015, plant_lines = all_lines_2015)
dethlingen_2015_relSY <- func_calc_relSY_valdis(dethlingen_2015, plant_lines = all_lines_2015)

# median per plant line
# 2014
mpi_fgh_2014_relSY_median <- func_calc_relSY_median(mpi_fgh_2014_relSY)
mpi_feld_2014_relSY_median <- func_calc_relSY_median(mpi_feld_2014_relSY)
jki_feld_2014_relSY_median <- func_calc_relSY_median(jki_feld_2014_relSY)
jki_shelter_2014_relSY_median <- func_calc_relSY_median(jki_shelter_2014_relSY)

# 2015
mpi_fgh_2015_relSY_median <- func_calc_relSY_median(mpi_fgh_2015_relSY)
mpi_feld_2015_relSY_median <- func_calc_relSY_median(mpi_feld_2015_relSY)
jki_feld_2015_relSY_median <- func_calc_relSY_median(jki_feld_2015_relSY)
jki_shelter_2015_relSY_median <- func_calc_relSY_median(jki_shelter_2015_relSY)
dethlingen_2015_relSY_median <- func_calc_relSY_median(dethlingen_2015_relSY)

# use mean per line (mean is calculated first, then relSY is calculated)
mpi_fgh_2014_relSY_mean <- func_calc_relSY_valdis(mpi_fgh_2014_mean_per_line, plant_lines = lines_2014)
```


# DRYM
## Calculate DRYM 2014
```{r calculate DRYM 2014}
# creates a LIST!
mpi_fgh_2014_drym <- func_calc_drym(mpi_fgh_2014_relSY, mpi_fgh_2014_relSY_median, 
                                    cultivar_names = lines_2014)

mpi_feld_2014_drym <- func_calc_drym(mpi_feld_2014_relSY, mpi_feld_2014_relSY_median, 
                                     cultivar_names = lines_2014)

jki_feld_2014_drym <- func_calc_drym(jki_feld_2014_relSY, jki_feld_2014_relSY_median, 
                                     cultivar_names = lines_2014)

jki_shelter_2014_drym <- func_calc_drym(jki_shelter_2014_relSY, jki_shelter_2014_relSY_median, 
                                        cultivar_names = lines_2014)

# median of DRYM per plant line (is a LIST!)
mpi_fgh_2014_drym_median <- lapply(mpi_fgh_2014_drym, median, na.rm=T)
mpi_feld_2014_drym_median <- lapply(mpi_feld_2014_drym, median, na.rm=T)
jki_feld_2014_drym_median <- lapply(jki_feld_2014_drym, median, na.rm=T)
jki_shelter_2014_drym_median <- lapply(jki_shelter_2014_drym, median, na.rm=T)

# Use median per line per experiment because of the different number of replicates in each experiment.
# This would lead to the emphasis of experiments with more replicates!
```


## Calculate DRYM 2015
```{r calculate DRYM 2015}
# creates a LIST!
mpi_fgh_2015_drym <- func_calc_drym(mpi_fgh_2015_relSY, mpi_fgh_2015_relSY_median, 
                                    cultivar_names = all_lines_2015)

mpi_feld_2015_drym <- func_calc_drym(mpi_feld_2015_relSY, mpi_feld_2015_relSY_median, 
                                     cultivar_names = all_lines_2015)

jki_feld_2015_drym <- func_calc_drym(jki_feld_2015_relSY, jki_feld_2015_relSY_median, 
                                     cultivar_names = all_lines_2015)

jki_shelter_2015_drym <- func_calc_drym(jki_shelter_2015_relSY, jki_shelter_2015_relSY_median, 
                                        cultivar_names = all_lines_2015)

dethlingen_2015_drym <- func_calc_drym(dethlingen_2015_relSY, dethlingen_2015_relSY_median, 
                                     cultivar_names = all_lines_2015)

# median of DRYM per plant line (is a LIST!)
mpi_fgh_2015_drym_median <- lapply(mpi_fgh_2015_drym, median, na.rm=T)
mpi_feld_2015_drym_median <- lapply(mpi_feld_2015_drym, median, na.rm=T)
jki_feld_2015_drym_median <- lapply(jki_feld_2015_drym, median, na.rm=T)
jki_shelter_2015_drym_median <- lapply(jki_shelter_2015_drym, median, na.rm=T)
dethlingen_2015_drym_median <- lapply(dethlingen_2015_drym, median, na.rm=T)

# Use median per line per experiment because of the different number of replicates in each experiment.
# This would lead to the emphasis of experiments with more replicates!
```


## Convert DRYM list to dataframe
```{r convert DRYM list to dataframe}
# mpi_fgh_2015_drym_df <- ldply(mpi_fgh_2015_drym, rbind)
# mpi_feld_2015_drym_df <- ldply(mpi_feld_2015_drym, rbind)
# jki_feld_2015_drym_df <- ldply(jki_feld_2015_drym, rbind)
# jki_shelter_2015_drym_df <- ldply(jki_shelter_2015_drym, rbind)
# dethlingen_2015_drym_df <- ldply(dethlingen_2015_drym, rbind)
# 
# colnames(mpi_fgh_2015_drym_df) <- c("plant_line", "mpi_fgh_1", "mpi_fgh_2", "mpi_fgh_3", "mpi_fgh_4", "mpi_fgh_5", "mpi_fgh_6")
# colnames(mpi_feld_2015_drym_df) <- c("plant_line", "mpi_feld_1", "mpi_feld_2", "mpi_feld_3")
# colnames(jki_feld_2015_drym_df) <- c("plant_line", "jki_feld_1", "jki_feld_2")
# colnames(jki_shelter_2015_drym_df) <- c("plant_line", "jki_shelter_1", "jki_shelter_2", "jki_shelter_3", 
#                                         "jki_shelter_4", "jki_shelter_5", "jki_shelter_6")
# colnames(dethlingen_2015_drym_df) <- c("plant_line", "dethlingen_1", "dethlingen_2")
# 
# drym_df_all_replicates <- cbind(mpi_fgh_2015_drym_df, mpi_feld_2015_drym_df[,-1], jki_feld_2015_drym_df[,-1], 
#                                 jki_shelter_2015_drym_df[,-1], dethlingen_2015_drym_df[,-1])
# 
# drym_df_melt <- melt(drym_df_all_replicates)
# head(drym_df_melt)
# 
# boxplot(drym_df_melt$value ~ drym_df_melt$plant_line, 
#         main = "DRYM of all experiments 2015", ylab = "DRYM", las = 2, cex.axis = 0.8, col = color_sp)
# abline(h=0, col = "red", lwd=2)
```


## DRYM of subpopulations
```{r DRYM of subpopulations}
# drym_sp1 <- subset(drym_df_melt, drym_df_melt$plant_line %in% plant_lines_sp1)
# drym_sp2 <- subset(drym_df_melt, drym_df_melt$plant_line %in% plant_lines_sp2)
# drym_sp3 <- subset(drym_df_melt, drym_df_melt$plant_line %in% plant_lines_sp3)
# 
# t.test(drym_sp1$value, drym_sp2$value)
# t.test(drym_sp1$value, drym_sp3$value)
# t.test(drym_sp2$value, drym_sp3$value)
```


## Combine DRYM median per line per experiment 2014
```{r combine DRYM median per line per experiment 2014}
drym_experiments_2014 <- rbind(as.data.frame(mpi_fgh_2014_drym_median),
                               as.data.frame(mpi_feld_2014_drym_median),
                               as.data.frame(jki_shelter_2014_drym_median),
                               as.data.frame(jki_feld_2014_drym_median))

dim(drym_experiments_2014)

drym_experiments_2014_melt <- melt(drym_experiments_2014)
colnames(drym_experiments_2014_melt) <- c("alias", "drym")

# add column for culture id
drym_experiments_2014_melt$culture <- rep( sort(unique(yield_data_final_2014$culture)), length(lines_2014))
dim(drym_experiments_2014_melt)
pander(head(drym_experiments_2014_melt))

# merge melted drym table with SP infos
drym_experiments_2014_melt_sp_dup <- droplevels(merge(drym_experiments_2014_melt, sp_infos_dup, by = "alias"))
dim(drym_experiments_2014_melt_sp_dup)
pander(head(drym_experiments_2014_melt_sp_dup))
```


## Combine DRYM median per line per experiment 2015
```{r combine DRYM median per line per experiment 2015}
drym_experiments_2015 <- rbind(as.data.frame(mpi_fgh_2015_drym_median),     # 72247
                               as.data.frame(mpi_feld_2015_drym_median),    # 72275
                               as.data.frame(jki_shelter_2015_drym_median), # 72292
                               as.data.frame(jki_feld_2015_drym_median),    # 72396
                               as.data.frame(dethlingen_2015_drym_median))  # 72482

dim(drym_experiments_2015)

drym_experiments_2015_melt <- melt(drym_experiments_2015)
colnames(drym_experiments_2015_melt) <- c("alias", "drym")

# add column for culture id
drym_experiments_2015_melt$culture <- rep( sort(unique(yield_data_final_2015$culture)), 63)
dim(drym_experiments_2015_melt)
pander(head(drym_experiments_2015_melt))

# merge melted drym table with SP infos
drym_experiments_2015_melt_sp_dup <- merge(drym_experiments_2015_melt, sp_infos_dup, by = "alias")
dim(drym_experiments_2015_melt_sp_dup)
pander(head(drym_experiments_2015_melt_sp_dup))
```


## Compare DRYM of subpopulations 2014
```{r compare DRYM of subpopulations 2014}
drym_median_2014_sp1 <- droplevels(subset(drym_experiments_2014_melt_sp_dup, drym_experiments_2014_melt_sp_dup$SP == "SP1"))
drym_median_2014_sp2 <- droplevels(subset(drym_experiments_2014_melt_sp_dup, drym_experiments_2014_melt_sp_dup$SP == "SP2"))
drym_median_2014_sp3 <- droplevels(subset(drym_experiments_2014_melt_sp_dup, drym_experiments_2014_melt_sp_dup$SP == "SP3"))

t.test(drym_median_2014_sp1$drym, drym_median_2014_sp2$drym)
t.test(drym_median_2014_sp1$drym, drym_median_2014_sp3$drym)
t.test(drym_median_2014_sp2$drym, drym_median_2014_sp3$drym)

# drym subsets per experiment
drym_mpi_fgh_2014 <- subset(drym_experiments_2014_melt_sp_dup, drym_experiments_2014_melt_sp_dup$culture == "67199")
drym_mpi_feld_2014 <- subset(drym_experiments_2014_melt_sp_dup, drym_experiments_2014_melt_sp_dup$culture == "67516")
drym_jki_shelter_2014 <- subset(drym_experiments_2014_melt_sp_dup, drym_experiments_2014_melt_sp_dup$culture == "68015")
drym_jki_feld_2014 <- subset(drym_experiments_2014_melt_sp_dup, drym_experiments_2014_melt_sp_dup$culture == "67518")
```


## Compare DRYM of subpopulations 2015
```{r compare DRYM of subpopulations 2015}
drym_median_2015_sp1 <- droplevels(subset(drym_experiments_2015_melt_sp_dup, drym_experiments_2015_melt_sp_dup$SP == "SP1"))
drym_median_2015_sp2 <- droplevels(subset(drym_experiments_2015_melt_sp_dup, drym_experiments_2015_melt_sp_dup$SP == "SP2"))
drym_median_2015_sp3 <- droplevels(subset(drym_experiments_2015_melt_sp_dup, drym_experiments_2015_melt_sp_dup$SP == "SP3"))

t.test(drym_median_2015_sp1$drym, drym_median_2015_sp2$drym)
t.test(drym_median_2015_sp1$drym, drym_median_2015_sp3$drym)
t.test(drym_median_2015_sp2$drym, drym_median_2015_sp3$drym)

# drym subsets per experiment
drym_mpi_fgh_2015 <- subset(drym_experiments_2015_melt_sp_dup, drym_experiments_2015_melt_sp_dup$culture == "72247")
drym_mpi_feld_2015 <- subset(drym_experiments_2015_melt_sp_dup, drym_experiments_2015_melt_sp_dup$culture == "72275")
drym_jki_shelter_2015 <- subset(drym_experiments_2015_melt_sp_dup, drym_experiments_2015_melt_sp_dup$culture == "72292")
drym_jki_feld_2015 <- subset(drym_experiments_2015_melt_sp_dup, drym_experiments_2015_melt_sp_dup$culture == "72396")
drym_dethlingen_2015 <- subset(drym_experiments_2015_melt_sp_dup, drym_experiments_2015_melt_sp_dup$culture == "72482")
```


## Plot DRYM per experiment and SP
```{r plot DRYM per experiment and SP}
# 2014
pdf("figures/valdis_boxplot_drym_sp_2014.pdf", width = 5, height = 5)
boxplot(drym_experiments_2014_melt_sp_dup$drym ~ drym_experiments_2014_melt_sp_dup$SP, 
        main = "all experiments", col = cols_sp, ylab = "DRYM (median per line)")
boxplot(drym_mpi_fgh_2014$drym ~ drym_mpi_fgh_2014$SP, main = "MPI FGH 2014", col = cols_sp, ylab = "DRYM (median per line)")
boxplot(drym_mpi_feld_2014$drym ~ drym_mpi_feld_2014$SP, main = "MPI Feld 2014", col = cols_sp, ylab = "DRYM (median per line)")
boxplot(drym_jki_shelter_2014$drym ~ drym_jki_shelter_2014$SP, main = "JKI Shelter 2014", col = cols_sp, ylab = "DRYM (median per line)")
boxplot(drym_jki_feld_2014$drym ~ drym_jki_feld_2014$SP, main = "JKI Feld 2014", col = cols_sp, ylab = "DRYM (median per line)")
dev.off()

# 2015
pdf("figures/valdis_boxplot_drym_sp_2015.pdf", width = 5, height = 5)
boxplot(drym_experiments_2015_melt_sp_dup$drym ~ drym_experiments_2015_melt_sp_dup$SP, 
        main = "all experiments", col = cols_sp, ylab = "DRYM (median per line)")
boxplot(drym_mpi_fgh_2015$drym ~ drym_mpi_fgh_2015$SP, main = "MPI FGH 2015", col = cols_sp, ylab = "DRYM (median per line)")
boxplot(drym_mpi_feld_2015$drym ~ drym_mpi_feld_2015$SP, main = "MPI Feld 2015", col = cols_sp, ylab = "DRYM (median per line)")
boxplot(drym_jki_shelter_2015$drym ~ drym_jki_shelter_2015$SP, main = "JKI Shelter 2015", col = cols_sp, ylab = "DRYM (median per line)")
boxplot(drym_jki_feld_2015$drym ~ drym_jki_feld_2015$SP, main = "JKI Feld 2015", col = cols_sp, ylab = "DRYM (median per line)")
boxplot(drym_dethlingen_2015$drym ~ drym_dethlingen_2015$SP, main = "Dethlingen 2015", col = cols_sp, ylab = "DRYM (median per line)")
dev.off()
```


## ANOVA of DRYM 2015
```{r ANOVA of DRYM 2015}
pander(head(drym_experiments_2015_melt_sp_dup))
dim(drym_experiments_2015_melt_sp_dup)

drym_anova <- func_anova_2fac_ia(drym_experiments_2015_melt_sp_dup, "drym", "culture", "SP", 0.05)
drym_anova

# SP * culture
summary(aov(drym_experiments_2015_melt_sp_dup$drym ~ drym_experiments_2015_melt_sp_dup$SP * drym_experiments_2015_melt_sp_dup$culture))

# alias (genotype)
summary(aov(drym_experiments_2015_melt_sp_dup$drym ~ drym_experiments_2015_melt_sp_dup$alias))
# alias (genotype) * culture
summary(aov(drym_experiments_2015_melt_sp_dup$drym ~ drym_experiments_2015_melt_sp_dup$alias * drym_experiments_2015_melt_sp_dup$culture))

dim(drym_mpi_fgh_2015)
pander(head(drym_mpi_fgh_2015))

summary(aov(drym_mpi_fgh_2015$drym ~ drym_mpi_fgh_2015$SP))
summary(aov(drym_mpi_feld_2015$drym ~ drym_mpi_feld_2015$SP))
summary(aov(drym_jki_shelter_2015$drym ~ drym_jki_shelter_2015$SP))
summary(aov(drym_jki_feld_2015$drym ~ drym_jki_feld_2015$SP))
summary(aov(drym_dethlingen_2015$drym ~ drym_dethlingen_2015$SP))
```


## Plot DRYM 2015
```{r plot DRYM 2015}
ylim_values <- range(drym_experiments_2015_melt_sp_dup$drym, na.rm=T)
# -0.227  0.429

pdf("figures/valdis_boxplot_drym_per_line_sp_2015.pdf", width = 9, height = 5)
par(mfrow = c(1,3))
boxplot(drym_median_2015_sp1$drym ~ drym_median_2015_sp1$alias, las = 2, ylab = "DRYM", 
        main = "DRYM of SP1", col = cols_sp[2], ylim = ylim_values)
abline(h=0, col = "red", lwd=2)
boxplot(drym_median_2015_sp2$drym ~ drym_median_2015_sp2$alias, las = 2, ylab = "DRYM", 
        main = "DRYM of SP2", col = cols_sp[3], ylim = ylim_values)
abline(h=0, col = "red", lwd=2)
boxplot(drym_median_2015_sp3$drym ~ drym_median_2015_sp3$alias, las = 2, ylab = "DRYM", 
        main = "DRYM of SP3", col = cols_sp[4], ylim = ylim_values)
abline(h=0, col = "red", lwd=2)

# order by median
drym_median_2015_sp1_ordered <- with(drym_median_2015_sp1, reorder(alias, -drym, median, na.rm=T))
drym_median_2015_sp2_ordered <- with(drym_median_2015_sp2, reorder(alias, -drym, median, na.rm=T))
drym_median_2015_sp3_ordered <- with(drym_median_2015_sp3, reorder(alias, -drym, median, na.rm=T))

boxplot(drym ~ drym_median_2015_sp1_ordered, data=drym_median_2015_sp1, las = 2, ylab = "DRYM", 
        main = "DRYM of SP1", col = cols_sp[2], ylim = ylim_values)
abline(h=0, col = "red", lwd=2)
boxplot(drym ~ drym_median_2015_sp2_ordered, data=drym_median_2015_sp2, las = 2, ylab = "DRYM", 
        main = "DRYM of SP2", col = cols_sp[3], ylim = ylim_values)
abline(h=0, col = "red", lwd=2)
boxplot(drym ~ drym_median_2015_sp3_ordered, data=drym_median_2015_sp3, las = 2, ylab = "DRYM", 
        main = "DRYM of SP3", col = cols_sp[4], ylim = ylim_values)
abline(h=0, col = "red", lwd=2)

dev.off()

par(mfrow = c(1,1))

# 
# drym_experiments_2015_melt_sp_median_order <- order(drym_experiments_2015_melt_sp_median$x, decreasing = T)
# 
# # define color
# color_sp <- heike_palette_6[sp_infos_ordered$SP]
# color_sp_ordered <- color_sp[drym_experiments_2015_melt_sp_median_order]
# 
# pdf("figures/boxplot_valdis_drym.pdf", width=10, height=6)
# palette(cols_sp)
# par(mar=c(6,4,4,2))
# boxplot(drym_experiments_2015_melt_sp_dup$drym ~ drym_experiments_2015_melt_sp_dup$alias, 
#         main = "DRYM of all experiments 2015", ylab = "DRYM", las = 2, cex.axis = 0.8, col = sp_infos$SP)
# abline(h=0, col = "red", lwd=2)
# legend("topright", levels(sp_infos_ordered$SP), fill = heike_palette_6)
# 
# # order by median
# drym_bymedian <- with(drym_experiments_2015_melt, reorder(plant_line, -drym, median, na.rm=T))
# boxplot(drym ~ drym_bymedian, data=drym_experiments_2015_melt, las = 2, col = color_sp_ordered)
# abline(h=0, col = "red", lwd=2)
# dev.off()
# 
# # http://stackoverflow.com/questions/3765950/sorting-a-boxplot-based-on-median-value
# 
# # ANOVA to check influcence of factor plant_line on DRYM
# summary(aov(drym_experiments_2015_melt$drym ~ drym_experiments_2015_melt$plant_line))
```


## Plot DRYM versus normalized SY 2014
```{r plot DRYM versus normalized SY 2014}
pander(head(yield_data_final_2014_control_norm_sy_mean))
dim(yield_data_final_2014_control_norm_sy_mean)

pander(head(drym_experiments_2014_melt))
dim(drym_experiments_2014_melt)

cor.test(yield_data_final_2014_control_norm_sy_mean$norm_sy, drym_experiments_2014_melt$drym)
# p-value < 2.2e-16
# cor: -0.3778671

dim(drym_experiments_2014_melt_sp_dup)
pander(head(drym_experiments_2014_melt_sp_dup))

# merge control_norm_SY table with SP infos
yield_data_final_2014_control_norm_sy_mean_sp_dup <- merge(yield_data_final_2014_control_norm_sy_mean, sp_infos_dup, by = "alias")
pander(head(yield_data_final_2014_control_norm_sy_mean_sp_dup))
dim(yield_data_final_2014_control_norm_sy_mean_sp_dup)

pdf("figures/valdis_control_norm_SY_vs_DRYM_2014.pdf")
plot(yield_data_final_2014_control_norm_sy_mean$norm_sy, drym_experiments_2014_melt$drym, pch = 19,
     xlab = "normalized starch yield of control", ylab = "median DRYM per line and per experiment")

# equivalent (da duplizierte Punkte sich überlagern)
# plot(yield_data_final_2014_control_norm_sy_mean_sp_dup$norm_sy, drym_experiments_2014_melt_sp_dup$drym, pch = 19,
#      xlab = "normalized starch yield of control", ylab = "median DRYM per line and per experiment")

palette(rainbow(5))
plot(yield_data_final_2014_control_norm_sy_mean$norm_sy, drym_experiments_2014_melt$drym, pch = 19,
     xlab = "normalized starch yield of control", ylab = "median DRYM per line and per experiment",
     col = as.factor(drym_experiments_2014_melt$culture))
legend("topright", fill = rainbow(5),
       legend = c("MPI FGH 2014", "MPI Feld 2014", "JKI Feld 2014", "JKI Shelter 2014"))

palette(cols_sp)
plot(yield_data_final_2014_control_norm_sy_mean_sp_dup$norm_sy, drym_experiments_2014_melt_sp_dup$drym, pch = 19,
     xlab = "normalized starch yield of control", ylab = "median DRYM per line and per experiment",
     col = drym_experiments_2014_melt_sp_dup$SP, cex = 1.2)
legend("topright", fill = cols_sp, legend = c("parents", "SP1", "SP2", "SP3"))

plot(yield_data_final_2014_control_norm_sy_mean_sp_dup$norm_sy, drym_experiments_2014_melt_sp_dup$drym, pch = 19,
     xlab = "normalized starch yield of control", ylab = "median DRYM per line and per experiment",
     col = drym_experiments_2014_melt_sp_dup$SP, cex = 1.2)
text(yield_data_final_2014_control_norm_sy_mean_sp_dup$norm_sy, drym_experiments_2014_melt_sp_dup$drym,
     labels = yield_data_final_2014_control_norm_sy_mean_sp_dup$alias, cex = 0.7)
legend("topright", fill = cols_sp, legend = c("parents", "SP1", "SP2", "SP3"))

dev.off()
```


## Plot DRYM versus normalized SY 2015
```{r plot DRYM versus normalized SY 2015}
pander(head(yield_data_final_2015_control_norm_sy_mean))
dim(yield_data_final_2015_control_norm_sy_mean)

pander(head(drym_experiments_2015_melt))
dim(drym_experiments_2015_melt)

cor.test(yield_data_final_2015_control_norm_sy_mean$norm_sy, drym_experiments_2015_melt$drym)
# p-value = 2.068e-09
# cor: -0.3324953


dim(drym_experiments_2015_melt_sp_dup)
pander(head(drym_experiments_2015_melt_sp_dup))

# merge control_norm_SY table with SP infos
yield_data_final_2015_control_norm_sy_mean_sp_dup <- merge(yield_data_final_2015_control_norm_sy_mean, sp_infos_dup, by = "alias")
pander(head(yield_data_final_2015_control_norm_sy_mean_sp_dup))
dim(yield_data_final_2015_control_norm_sy_mean_sp_dup)

pdf("figures/valdis_control_norm_SY_vs_DRYM_2015.pdf")
plot(yield_data_final_2015_control_norm_sy_mean$norm_sy, drym_experiments_2015_melt$drym, pch = 19,
     xlab = "normalized starch yield of control", ylab = "median DRYM per line and per experiment")

# equivalent (da duplizierte Punkte sich überlagern)
# plot(yield_data_final_2015_control_norm_sy_mean_sp_dup$norm_sy, drym_experiments_2015_melt_sp_dup$drym, pch = 19,
#      xlab = "normalized starch yield of control", ylab = "median DRYM per line and per experiment")

palette(rainbow(5))
plot(yield_data_final_2015_control_norm_sy_mean$norm_sy, drym_experiments_2015_melt$drym, pch = 19,
     xlab = "normalized starch yield of control", ylab = "median DRYM per line and per experiment",
     col = as.factor(drym_experiments_2015_melt$culture))
legend("topright", fill = rainbow(5),
       legend = c("MPI FGH 2015", "MPI Feld 2015", "JKI Shelter 2015", "JKI Feld 2015", "Dethlingen 2015"))

palette(cols_sp)
plot(yield_data_final_2015_control_norm_sy_mean_sp_dup$norm_sy, drym_experiments_2015_melt_sp_dup$drym, pch = 19,
     xlab = "normalized starch yield of control", ylab = "median DRYM per line and per experiment",
     col = drym_experiments_2015_melt_sp_dup$SP, cex = 1.2)
legend("topright", fill = cols_sp, legend = c("parents", "SP1", "SP2", "SP3"))

plot(yield_data_final_2015_control_norm_sy_mean_sp_dup$norm_sy, drym_experiments_2015_melt_sp_dup$drym, pch = 19,
     xlab = "normalized starch yield of control", ylab = "median DRYM per line and per experiment",
     col = drym_experiments_2015_melt_sp_dup$SP, cex = 1.2)
text(yield_data_final_2015_control_norm_sy_mean_sp_dup$norm_sy, drym_experiments_2015_melt_sp_dup$drym,
     labels = yield_data_final_2015_control_norm_sy_mean_sp_dup$alias, cex = 0.7)
legend("topright", fill = cols_sp, legend = c("parents", "SP1", "SP2", "SP3"))

dev.off()
```


# Pairs plot of DRYM
```{r pairs plot of DRYM, warning=FALSE}
drym_experiments_2015_t <- as.data.frame(t(drym_experiments_2015))
#colnames(drym_experiments_2015_t) <- c("MPI FGH 2015","MPI Feld 2015", "JKI Shelter 2015", "JKI Feld 2015", "Dethlingen 2015")
colnames(drym_experiments_2015_t) <- c("MPI_FGH_2015","MPI_Feld_2015","JKI_Shelter_2015","JKI_Feld_2015","Dethlingen_2015")
pander(head(drym_experiments_2015_t))

cor.test(drym_experiments_2015_t$MPI_FGH_2015, drym_experiments_2015_t$JKI_Shelter_2015)
cor.test(drym_experiments_2015_t$MPI_Feld_2015, drym_experiments_2015_t$JKI_Shelter_2015)
cor.test(drym_experiments_2015_t$JKI_Shelter_2015, drym_experiments_2015_t$MPI_Feld_2015)
cor.test(drym_experiments_2015_t$MPI_FGH_2015, drym_experiments_2015_t$MPI_Feld_2015)


pdf("figures/valdis_pairs_drym.pdf")
pairs(drym_experiments_2015_t, lower.panel=panel.smooth, upper.panel=panel.cor, pch=19)

pairs(drym_experiments_2015_t, pch=19)

pairs.annot(drym_experiments_2015_t, pch=19)

ggpairs(drym_experiments_2015_t)

dev.off()
```

# Correlation between starch yield and starch content
```{r Correlation between starch yield and starch content}
#plot(yield_data_2015_sy$number, yield_data_2015_sc$number)


func_plot_sy_vs_sc <- function(dataset, main_text){
  plot(dataset$starch_yield_g_per_plant, dataset$starch_g_per_kg, 
       col = cols_treatment[dataset$treatment_name], 
       pch = 19,
       xlab = "starch yield in g per plant",
       ylab = "starch content in g per kg",
       main = main_text)
}

func_boxplot_sc <- function(dataset, main_text){
  boxplot(dataset$starch_g_per_kg ~ dataset$treatment_name, 
       col = cols_treatment, 
       ylab = "starch content in g per kg",
       main = main_text)
}
```


## Correlation between starch yield and starch content 2014
```{r Correlation between starch yield and starch content 2014}
pdf("figures/valdis_2014_SY_vs_SC.pdf", width=8, height=8)
par(mfrow=c(2,2))
func_plot_sy_vs_sc(mpi_fgh_2014, "MPI FGH 2014")
func_boxplot_sc(mpi_fgh_2014, "MPI FGH 2014")

func_plot_sy_vs_sc(mpi_feld_2014, "MPI Feld 2014")
func_boxplot_sc(mpi_feld_2014, "MPI Feld 2014")

func_plot_sy_vs_sc(jki_shelter_2014, "JKI Pot 2014")
func_boxplot_sc(jki_shelter_2014, "JKI Pot 2014")

func_plot_sy_vs_sc(jki_feld_2014, "JKI Feld 2014")
func_boxplot_sc(jki_feld_2014, "JKI Feld 2014")

dev.off()
```


## Correlation between starch yield and starch content 2015
```{r Correlation between starch yield and starch content 2015}
pdf("figures/valdis_2015_SY_vs_SC.pdf", width=8, height=8)
par(mfrow=c(2,2))
func_plot_sy_vs_sc(mpi_fgh_2015, "MPI FGH 2015")
func_boxplot_sc(mpi_fgh_2015, "MPI FGH 2015")

func_plot_sy_vs_sc(mpi_feld_2015, "MPI Feld 2015")
func_boxplot_sc(mpi_feld_2015, "MPI Feld 2015")

func_plot_sy_vs_sc(jki_shelter_2015, "JKI Pot 2015")
func_boxplot_sc(jki_shelter_2015, "JKI Pot 2015")

func_plot_sy_vs_sc(jki_feld_2015, "JKI Feld 2015")
func_boxplot_sc(jki_feld_2015, "JKI Feld 2015")

func_plot_sy_vs_sc(dethlingen_2015, "Dethlingen 2015")
func_boxplot_sc(dethlingen_2015, "Dethlingen 2015")
dev.off()
```



# Calculate Stress Sensitivity Index (SSI)

$$
SSI = \frac{1 - \frac{Yield_{stress}}{Yield_{control}}}{SI} \\
SI = 1 - \frac{\overline{Yield}_{stress}}{\overline{Yield}_{control}}
$$

**High value of SSI corresponds to sensitive genotype**
**Low value of SSI corresponds to tolerant genotype**

```{r calculate SSI}
# 2014
mpi_fgh_2014_ssi <- func_calc_ssi(mpi_fgh_2014, plant_lines = lines_2014, mpi_fgh_2014_si)
mpi_feld_2014_ssi <- func_calc_ssi(mpi_feld_2014, plant_lines = lines_2014, mpi_feld_2014_si)
jki_shelter_2014_ssi <- func_calc_ssi(jki_shelter_2014, plant_lines = lines_2014, jki_shelter_2014_si)
jki_feld_2014_ssi <- func_calc_ssi(jki_feld_2014, plant_lines = lines_2014, jki_feld_2014_si)

# mean per line 
mpi_fgh_2014_ssi_mean <- func_calc_ssi(mpi_fgh_2014, plant_lines = lines_2014, mpi_fgh_2014_si, keep_replicates = "no")
mpi_feld_2014_ssi_mean <- func_calc_ssi(mpi_feld_2014, plant_lines = lines_2014, mpi_feld_2014_si, keep_replicates = "no")
jki_shelter_2014_ssi_mean <- func_calc_ssi(jki_shelter_2014, plant_lines = lines_2014, jki_shelter_2014_si, keep_replicates = "no")
jki_feld_2014_ssi_mean <- func_calc_ssi(jki_feld_2014, plant_lines = lines_2014, jki_feld_2014_si, keep_replicates = "no")

# 2015
mpi_fgh_2015_ssi <- func_calc_ssi(mpi_fgh_2015, plant_lines = all_lines_2015, mpi_fgh_2015_si)
mpi_feld_2015_ssi <- func_calc_ssi(mpi_feld_2015, plant_lines = all_lines_2015, mpi_feld_2015_si)
jki_shelter_2015_ssi <- func_calc_ssi(jki_shelter_2015, plant_lines = all_lines_2015, jki_shelter_2015_si)
jki_feld_2015_ssi <- func_calc_ssi(jki_feld_2015, plant_lines = all_lines_2015, jki_feld_2015_si)
dethlingen_2015_ssi <- func_calc_ssi(dethlingen_2015, plant_lines = all_lines_2015, dethlingen_2015_si)

# mean per line
mpi_fgh_2015_ssi_mean <- func_calc_ssi(mpi_fgh_2015, plant_lines = all_lines_2015, mpi_fgh_2015_si, keep_replicates = "no")
mpi_feld_2015_ssi_mean <- func_calc_ssi(mpi_feld_2015, plant_lines = all_lines_2015, mpi_feld_2015_si, keep_replicates = "no")
jki_shelter_2015_ssi_mean <- func_calc_ssi(jki_shelter_2015, plant_lines = all_lines_2015, jki_shelter_2015_si, keep_replicates = "no")
jki_feld_2015_ssi_mean <- func_calc_ssi(jki_feld_2015, plant_lines = all_lines_2015, jki_feld_2015_si, keep_replicates = "no")
dethlingen_2015_ssi_mean <- func_calc_ssi(dethlingen_2015, plant_lines = all_lines_2015, dethlingen_2015_si, keep_replicates = "no")
```


## Plot SSI versus DRYM
```{r plot SSI versus DRYM}
plot(unlist(mpi_feld_2015_ssi), unlist(mpi_feld_2015_relSY))
plot(unlist(mpi_feld_2015_ssi_median), unlist(mpi_feld_2015_relSY_median))

plot(unlist(mpi_feld_2015_ssi), unlist(mpi_feld_2015_drym))
plot(unlist(mpi_feld_2015_ssi_median), unlist(mpi_feld_2015_drym_median))

plot(unlist(mpi_fgh_2015_ssi), unlist(mpi_fgh_2015_drym))
plot(unlist(jki_shelter_2015_ssi), unlist(jki_shelter_2015_drym))
plot(unlist(jki_feld_2015_ssi), unlist(jki_feld_2015_drym))

plot(unlist(jki_feld_2014_ssi), unlist(jki_feld_2014_drym))
plot(unlist(jki_shelter_2014_ssi), unlist(jki_shelter_2014_drym))

# negative correlation between drym and ssi --> higher ssi means more sensitive
```


# Save workspace
```{r save workspace}
save.image("yield_data_valdis.RData")
```
